<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Archaic Cross-Traditional Reference</title>
    <style>
        :root {
            /* Base Typography */
            --font-serif: "Times New Roman", Times, serif;
            --font-sans: system-ui, -apple-system, sans-serif;
            
            /* Layout */
            --spacing: 8px;
            
            /* Dynamic Theme Variables (Defaults) */
            --bg-color: #0f172a;
            --surface-color: #1e293b;
            --border-color: #334155;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --accent-color: #cbd5e1;
            
            /* Symbolic Colors */
            --color-fire: #ef4444;
            --color-earth: #d97706;
            --color-air: #f59e0b;
            --color-water: #3b82f6;
            
            --color-plant: #22c55e;
            --color-bad: #f43f5e;
            --color-good: #10b981;
            --color-neutral: #94a3b8;
            --color-caution: #f59e0b;
            
            /* Tradition Colors */
            --color-celtic: #10b981;
            --color-tcm: #f43f5e;
            --color-shaman: #a855f7;
            --color-quero: #f97316;
            --color-redpath: #ef4444;
            --color-alchemy: #6366f1;
            --color-tibetan: #eab308;
            --color-pagan: #d946ef;
            --color-slavic: #ef4444;
            --color-scottish: #0ea5e9;
            
            /* New Tradition Colors */
            --color-hebrew: #3b82f6; /* Blue */
            --color-islamic: #10b981; /* Green */
            --color-roman: #b91c1c; /* Imperial Red */
            --color-anglo: #854d0e; /* Ancient Gold */
            --color-vedic: #f97316; /* Orange/Saffron */
            --color-meso: #14b8a6; /* Teal/Jade */
            --color-african: #8b5cf6; /* Violet */
            --color-balkan: #dc2626; /* Deep Red */
            
            /* Shamanic & Entheogen Colors */
            --color-andean: #b45309; /* Earthy Terracotta */
            --color-amazon: #15803d; /* Deep Jungle Green */
            --color-mushroom: #9333ea; /* Mystic Purple */
            
            --color-herb-leaf: #4ade80;
            --color-herb-flower: #f472b6;
            --color-herb-fruit: #ef4444;
            --color-herb-root: #d97706;
            
            /* Deity Colors */
            --color-egypt: #f59e0b; 
            --color-marian: #38bdf8; 
            --color-buddhist: #a3e635;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-sans);
            transition: background-color 0.3s, color 0.3s;
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        h1, h2, h3, h4, .serif { font-family: var(--font-serif); }
        button { cursor: pointer; font-family: inherit; }
        input, select { font-family: inherit; }

        /* Icons */
        .icon { display: inline-block; vertical-align: middle; fill: currentColor; }
        .icon-xl { width: 80px; height: 80px; }
        .icon-lg { width: 48px; height: 48px; }
        .icon-md { width: 32px; height: 32px; }
        .icon-sm { width: 20px; height: 20px; }
        
        .icon-shadow { filter: drop-shadow(0px 2px 3px rgba(0,0,0,0.5)); }
        
        /* Animations */
        @keyframes pulse-soft { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
        .anim-pulse:hover { animation: pulse-soft 1.5s ease-in-out infinite; transform-origin: center; }

        @keyframes rock-gentle { 0% { transform: rotate(0deg); } 25% { transform: rotate(-12deg); } 75% { transform: rotate(12deg); } 100% { transform: rotate(0deg); } }
        .anim-rock:hover { animation: rock-gentle 0.8s ease-in-out; transform-origin: center bottom; }

        @keyframes float-up { 0% { transform: translateY(0); } 50% { transform: translateY(-3px); } 100% { transform: translateY(0); } }
        .anim-float:hover { animation: float-up 2s ease-in-out infinite; }

        @keyframes spin-glow { 0% { filter: drop-shadow(0 0 2px currentColor); transform: rotate(0deg); } 50% { filter: drop-shadow(0 0 6px currentColor); } 100% { filter: drop-shadow(0 0 2px currentColor); transform: rotate(360deg); } }
        .anim-spin-glow:hover { animation: spin-glow 3s linear infinite; transform-origin: center; }

        .moon-anim { transition: transform 0.5s ease, filter 0.5s ease; }
        .day-cell:hover .moon-anim { transform: scale(1.08) rotate(2deg); filter: drop-shadow(0 0 8px var(--accent-color)); }
        
        #app { display: flex; flex-direction: column; height: 100%; z-index: 1; position: relative; }

        /* Logo */
        #user-logo {
            position: absolute; z-index: 50; max-width: 150px; max-height: 80px; pointer-events: none; opacity: 0.9;
            transition: all 0.3s ease; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        .logo-top-center { top: 8px; left: 50%; transform: translateX(-50%); }
        .logo-top-center:hover { transform: translateX(-50%) scale(1.05); filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5)) !important; opacity: 1 !important; }
        .logo-bottom-right { bottom: 20px; right: 20px; transform: none; }
        .logo-bottom-right:hover { transform: scale(1.05); filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5)) !important; opacity: 1 !important; }

        header {
            padding: 16px 20px; border-bottom: 1px solid var(--border-color); background: var(--surface-color);
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; gap: 16px; flex-wrap: wrap;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); z-index: 10; position: relative;
        }
        .header-info { display: flex; align-items: center; gap: 20px; }
        .header-text { display: flex; flex-direction: column; }
        .header-main-text { font-family: var(--font-serif); font-size: 1.5rem; font-weight: bold; line-height: 1.2; }
        .header-sub-text { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; margin-top: 4px; }
        .header-trad { font-size: 0.8rem; color: var(--accent-color); opacity: 0.9; font-style: italic; }
        
        .live-clock {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 2px;
            font-family: var(--font-sans);
            opacity: 0.9;
            letter-spacing: 0.02em;
        }

        .controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; justify-content: flex-end; }
        
        button.nav-btn { background: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-main); padding: 8px 16px; border-radius: 6px; font-weight: bold; transition: all 0.2s; }
        button.nav-btn:hover { background: var(--surface-color); border-color: var(--accent-color); }
        button.text-btn { background: none; border: none; color: var(--text-muted); text-decoration: underline; font-size: 0.85rem; white-space: nowrap; }
        button.text-btn:hover { color: var(--accent-color); }
        
        /* Prominent Filter Button */
        #btn-filters, #btn-summary { background: var(--accent-color); color: var(--bg-color); border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        #btn-filters:hover, #btn-summary:hover { filter: brightness(1.1); transform: translateY(-1px); }

        input[type="date"], select { background: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-main); padding: 7px; border-radius: 6px; }

        /* Calendar Grid */
        .calendar-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 12px; background: var(--bg-color); }
        .weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 0.75rem; color: var(--text-muted); padding-bottom: 12px; text-transform: uppercase; letter-spacing: 0.15em; border-bottom: 1px solid var(--border-color); font-weight: 600; }
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); grid-auto-rows: 1fr; gap: 2px; background: var(--border-color); flex: 1; overflow-y: auto; border-radius: 0 0 4px 4px; }
        
        .day-cell { background: var(--bg-color); padding: 6px; position: relative; display: flex; flex-direction: column; min-height: 110px; transition: background 0.2s; cursor: pointer; overflow: hidden; }
        .day-cell:hover { background: var(--surface-color); }
        .day-cell.today { background: color-mix(in srgb, var(--surface-color), transparent 60%); border: 2px solid var(--accent-color); }
        .day-cell.selected { background: var(--surface-color); box-shadow: inset 0 0 0 2px var(--accent-color); }
        
        /* PLANT MEDICINE EMPHASIS (Advisory Tone) */
        .day-cell.plant-medicine { 
            border: 1px solid var(--color-mushroom); 
            background: linear-gradient(135deg, transparent 92%, color-mix(in srgb, var(--color-mushroom), transparent 88%) 100%);
        }
        
        .day-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px; padding-bottom: 4px; border-bottom: 1px solid transparent; }
        .day-cell:hover .day-header { border-bottom-color: var(--border-color); }
        .day-number { font-size: 0.95rem; font-weight: 700; opacity: 0.8; }
        .note-dot { width: 8px; height: 8px; background: var(--accent-color); border-radius: 50%; display: none; box-shadow: 0 0 4px var(--accent-color); }
        .has-note .note-dot { display: block; }
        .weekday-indicator { opacity: 0.8; transition: opacity 0.2s; }
        .day-cell:hover .weekday-indicator { opacity: 1; }
        .day-center { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; padding: 4px 0; }
        .day-footer { display: flex; justify-content: space-between; align-items: flex-end; padding-top: 4px; }
        .icon-row { display: flex; gap: 4px; align-items: center; flex-wrap: wrap; justify-content: flex-end; }
        
        /* Corner Icons for Plant Medicine & Ceremonial */
        .corner-icons { position: absolute; top: 4px; right: 4px; display: flex; flex-direction: column; gap: 4px; align-items: flex-end; pointer-events: none; z-index: 5; }
        .corner-icon { pointer-events: auto; transition: transform 0.2s; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.5)); }
        .corner-icon:hover { transform: scale(1.2); }

        /* Panels */
        .detail-panel, .settings-panel, .summary-panel { position: fixed; top: 0; right: 0; bottom: 0; width: 480px; max-width: 90vw; background: var(--surface-color); border-left: 1px solid var(--border-color); padding: 32px; overflow-y: auto; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: -10px 0 30px rgba(0,0,0,0.6); z-index: 100; }
        .detail-panel.open, .settings-panel.open, .summary-panel.open { transform: translateX(0); }
        .detail-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; margin-bottom: 24px; }
        .close-btn { background: none; border: none; font-size: 2rem; color: var(--text-muted); line-height: 0.8; padding: 4px; }
        
        .panel-section { margin-bottom: 32px; }
        .section-title { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.15em; color: var(--accent-color); border-bottom: 1px solid var(--border-color); padding-bottom: 8px; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; }
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .data-item { display: flex; flex-direction: column; gap: 4px; }
        .data-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
        .data-value { font-family: var(--font-serif); font-size: 1.1rem; }
        .context-box { background: color-mix(in srgb, var(--bg-color), transparent 30%); padding: 16px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.95rem; line-height: 1.6; margin-bottom: 12px; }
        
        /* Summary Panel Specifics */
        .summary-item { padding: 12px; border-bottom: 1px solid var(--border-color); display: flex; gap: 12px; }
        .summary-date { font-family: var(--font-serif); font-weight: bold; min-width: 60px; color: var(--accent-color); font-size: 1.1rem; }
        .summary-content { flex: 1; }
        .summary-title { font-weight: bold; margin-bottom: 4px; font-size: 0.95rem; }
        .summary-meta { font-size: 0.85rem; color: var(--text-muted); }
        .summary-tag { display: inline-block; font-size: 0.7rem; text-transform: uppercase; padding: 2px 6px; border-radius: 4px; margin-right: 6px; border: 1px solid currentColor; opacity: 0.8; }
        
        /* Toggle Switch */
        .toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
        .toggle-label { font-size: 0.95rem; }
        .toggle-wrapper { display: flex; align-items: center; gap: 12px; }
        .toggle-input { display: none; }
        .toggle-switch { width: 40px; height: 20px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 20px; position: relative; cursor: pointer; transition: background 0.2s; }
        .toggle-switch::after { content: ''; position: absolute; width: 14px; height: 14px; background: var(--text-muted); border-radius: 50%; top: 2px; left: 2px; transition: transform 0.2s, background 0.2s; }
        .toggle-input:checked + .toggle-switch { background: var(--accent-color); border-color: var(--accent-color); }
        .toggle-input:checked + .toggle-switch::after { transform: translateX(20px); background: var(--bg-color); }
        
        .btn-solo { background: transparent; border: 1px solid var(--text-muted); color: var(--text-muted); font-size: 0.65rem; text-transform: uppercase; padding: 2px 6px; border-radius: 4px; cursor: pointer; transition: all 0.2s; }
        .btn-solo:hover { border-color: var(--accent-color); color: var(--accent-color); }
        
        /* Suitability Layout */
        .suitability-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .suit-col { display: flex; flex-direction: column; gap: 8px; }
        .suit-header { font-size: 0.75rem; text-transform: uppercase; font-weight: bold; color: var(--text-muted); border-bottom: 1px solid var(--border-color); padding-bottom: 4px; }
        .suit-item { font-size: 0.85rem; padding: 10px; border-radius: 4px; background: color-mix(in srgb, var(--bg-color), transparent 50%); border-left: 3px solid transparent; line-height: 1.4; }
        .suit-good { border-left-color: var(--color-good); }
        .suit-bad { border-left-color: var(--color-bad); }
        .hair-box { background: var(--surface-color); border: 1px solid var(--border-color); padding: 12px; border-radius: 4px; display: flex; align-items: center; gap: 16px; margin-bottom: 16px; }
        .hair-status { font-weight: bold; text-transform: uppercase; font-size: 0.9rem; margin-top: 2px; }
        .status-good { color: var(--color-good); }
        .status-bad { color: var(--color-bad); }
        .status-neutral { color: var(--color-neutral); }
        
        .work-list { display: flex; flex-direction: column; gap: 10px; }
        .work-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 4px; transition: border-color 0.2s; }
        .work-item:hover { border-color: var(--accent-color); }
        .work-tag { font-size: 0.7rem; text-transform: uppercase; padding: 4px 8px; border-radius: 4px; font-weight: bold; min-width: 80px; text-align: center; }
        .tag-suitable { color: var(--color-plant); border: 1px solid var(--color-plant); background: color-mix(in srgb, var(--color-plant), transparent 90%); }
        .tag-avoid { color: var(--color-bad); border: 1px solid var(--color-bad); background: color-mix(in srgb, var(--color-bad), transparent 90%); }
        .tag-mixed { color: var(--text-muted); border: 1px solid var(--text-muted); background: color-mix(in srgb, var(--text-muted), transparent 90%); }
        /* Tradition Tags */
        .tag-egypt { color: var(--color-egypt); border: 1px solid var(--color-egypt); background: color-mix(in srgb, var(--color-egypt), transparent 90%); }
        .tag-marian { color: var(--color-marian); border: 1px solid var(--color-marian); background: color-mix(in srgb, var(--color-marian), transparent 90%); }
        .tag-buddhist { color: var(--color-buddhist); border: 1px solid var(--color-buddhist); background: color-mix(in srgb, var(--color-buddhist), transparent 90%); }
        .tag-pagan { color: var(--color-pagan); border: 1px solid var(--color-pagan); background: color-mix(in srgb, var(--color-pagan), transparent 90%); }
        .tag-slavic { color: var(--color-slavic); border: 1px solid var(--color-slavic); background: color-mix(in srgb, var(--color-slavic), transparent 90%); }
        .tag-scottish { color: var(--color-scottish); border: 1px solid var(--color-scottish); background: color-mix(in srgb, var(--color-scottish), transparent 90%); }
        
        .tag-hebrew { color: var(--color-hebrew); border: 1px solid var(--color-hebrew); background: color-mix(in srgb, var(--color-hebrew), transparent 90%); }
        .tag-islamic { color: var(--color-islamic); border: 1px solid var(--color-islamic); background: color-mix(in srgb, var(--color-islamic), transparent 90%); }
        .tag-roman { color: var(--color-roman); border: 1px solid var(--color-roman); background: color-mix(in srgb, var(--color-roman), transparent 90%); }
        .tag-anglo { color: var(--color-anglo); border: 1px solid var(--color-anglo); background: color-mix(in srgb, var(--color-anglo), transparent 90%); }
        
        .tag-vedic { color: var(--color-vedic); border: 1px solid var(--color-vedic); background: color-mix(in srgb, var(--color-vedic), transparent 90%); }
        .tag-meso { color: var(--color-meso); border: 1px solid var(--color-meso); background: color-mix(in srgb, var(--color-meso), transparent 90%); }
        .tag-african { color: var(--color-african); border: 1px solid var(--color-african); background: color-mix(in srgb, var(--color-african), transparent 90%); }
        .tag-balkan { color: var(--color-balkan); border: 1px solid var(--color-balkan); background: color-mix(in srgb, var(--color-balkan), transparent 90%); }
        
        .tag-andean { color: var(--color-andean); border: 1px solid var(--color-andean); background: color-mix(in srgb, var(--color-andean), transparent 90%); }
        .tag-amazon { color: var(--color-amazon); border: 1px solid var(--color-amazon); background: color-mix(in srgb, var(--color-amazon), transparent 90%); }
        .tag-mushroom { color: var(--color-mushroom); border: 1px solid var(--color-mushroom); background: color-mix(in srgb, var(--color-mushroom), transparent 90%); }
        .tag-redpath { color: var(--color-redpath); border: 1px solid var(--color-redpath); background: color-mix(in srgb, var(--color-redpath), transparent 90%); }

        textarea.notes-area { width: 100%; background: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-main); padding: 12px; min-height: 140px; font-family: var(--font-sans); margin-top: 8px; border-radius: 4px; line-height: 1.5; }
        textarea.notes-area:focus { outline: none; border-color: var(--accent-color); }

        /* Bib Panel */
        .bib-panel { position: fixed; inset: 0; background: var(--bg-color); z-index: 200; padding: 40px; overflow-y: auto; transform: translateY(100%); transition: transform 0.3s ease-in-out; }
        .bib-panel.open { transform: translateY(0); }
        .bib-container { max-width: 800px; margin: 0 auto; }
        .bib-item { margin-bottom: 24px; border-bottom: 1px solid var(--border-color); padding-bottom: 16px; }
        .bib-title { font-weight: bold; color: var(--text-main); font-size: 1.1rem; margin-bottom: 4px; }
        .bib-meta { font-size: 0.9rem; color: var(--text-muted); line-height: 1.5; }

        #global-tooltip { position: fixed; background: var(--surface-color); border: 1px solid var(--accent-color); color: var(--text-main); padding: 12px; font-size: 0.85rem; z-index: 9999; pointer-events: none; opacity: 0; transition: opacity 0.2s; box-shadow: 0 4px 20px rgba(0,0,0,0.6); border-radius: 6px; max-width: 320px; line-height: 1.5; text-align: left; left: 0; top: 0; }

        @media (max-width: 600px) {
            header { padding: 10px; gap: 8px; justify-content: center; }
            .header-info { width: 100%; justify-content: center; margin-bottom: 8px; gap: 12px; }
            .icon-xl { width: 48px; height: 48px; }
            .header-main-text { font-size: 1.1rem; text-align: center; }
            .header-sub-text, .header-trad { text-align: center; }
            .controls { width: 100%; justify-content: space-between; gap: 4px; overflow-x: auto; padding-bottom: 4px; }
            .day-cell { min-height: 70px; padding: 2px; }
            .detail-panel, .settings-panel, .summary-panel { width: 100%; max-width: 100%; border-left: none; padding: 20px 16px; }
            .suitability-grid { grid-template-columns: 1fr; }
            #user-logo { max-width: 80px; max-height: 50px; }
            .logo-top-center { top: 2px; }
            .logo-bottom-right { bottom: 70px; right: 10px; }
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react/": "https://esm.sh/react@^19.2.3/",
    "lucide-react": "https://esm.sh/lucide-react@^0.561.0"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>

<div id="global-tooltip"></div>
<img id="user-logo" src="logo.png" style="display:none;" alt="Archaic Reference" />

<div id="app">
    <header>
        <div class="header-info">
            <div id="header-moon-icon" class="icon-xl icon-shadow"></div>
            <div class="header-text">
                <div id="live-clock" class="live-clock"></div>
                <span id="header-date" class="header-main-text"></span>
                <span id="header-doy" class="header-sub-text"></span>
                <span id="header-trad-name" class="header-trad"></span>
            </div>
        </div>
        <div class="controls">
            <button id="btn-prev" class="nav-btn">&larr;</button>
            <input type="date" id="date-picker">
            <button id="btn-next" class="nav-btn">&rarr;</button>
            <button id="btn-summary" class="nav-btn">Summary</button>
            <button id="btn-filters" class="nav-btn">Filters</button>
            <select id="theme-selector" class="theme-selector"></select>
            <button id="btn-logo" class="text-btn">Logo</button>
            <button id="btn-bib" class="text-btn">Sources</button>
        </div>
    </header>

    <div class="calendar-container">
        <div class="weekdays"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div>
        <div id="calendar-grid" class="days-grid"></div>
    </div>

    <!-- SETTINGS PANEL -->
    <aside id="settings-panel" class="settings-panel">
        <div class="detail-header">
            <h2 class="serif" style="margin:0; font-size: 1.8rem; color: var(--text-main);">Filters & Visibility</h2>
            <button id="btn-close-settings" class="close-btn">&times;</button>
        </div>
        <div class="panel-section">
            <div class="section-title">Traditions & Lineages</div>
            <div id="settings-traditions"></div>
        </div>
        <div class="panel-section">
            <div class="section-title">Day Types</div>
            <div id="settings-types"></div>
        </div>
    </aside>

    <!-- SUMMARY PANEL -->
    <aside id="summary-panel" class="summary-panel">
        <div class="detail-header">
            <h2 class="serif" style="margin:0; font-size: 1.8rem; color: var(--text-main);">Month Summary</h2>
            <button id="btn-close-summary" class="close-btn">&times;</button>
        </div>
        <div id="summary-content" style="display: flex; flex-direction: column; gap: 4px;"></div>
    </aside>

    <aside id="detail-panel" class="detail-panel">
        <div class="detail-header">
            <div>
                <h2 id="detail-date" class="serif" style="margin:0; font-size: 1.8rem; color: var(--text-main);"></h2>
                <div style="display:flex; align-items:center; gap:8px; margin-top:8px;">
                    <div id="detail-weekday-icon"></div>
                    <div id="detail-weekday" style="color: var(--accent-color); font-size: 0.95rem;"></div>
                </div>
            </div>
            <button id="btn-close" class="close-btn">&times;</button>
        </div>

        <!-- SUITABILITY SECTION -->
        <div class="panel-section">
            <div class="section-title">Daily Suitability & Guidance</div>
            
            <div id="detail-hair-container"></div>

            <div class="suitability-grid">
                <div class="suit-col">
                    <div class="suit-header" style="color:var(--color-good)">Good For</div>
                    <div id="list-good" style="display:flex; flex-direction:column; gap:4px;"></div>
                </div>
                <div class="suit-col">
                    <div class="suit-header" style="color:var(--color-bad)">Not Suitable For</div>
                    <div id="list-bad" style="display:flex; flex-direction:column; gap:4px;"></div>
                </div>
            </div>

            <div class="context-box">
                <div class="data-label">Ceremonial Focus</div>
                <div id="detail-ceremony-focus" style="font-style:italic;"></div>
            </div>
        </div>

        <div class="panel-section">
            <div class="section-title">Astronomical Data</div>
            <div class="data-grid">
                <div class="data-item"><span class="data-label">Phase & Zodiac</span><span id="detail-phase" class="data-value"></span></div>
                <div class="data-item"><span class="data-label">Age</span><span id="detail-age" class="data-value"></span></div>
                <div class="data-item"><span class="data-label">Illumination</span><span id="detail-illum" class="data-value"></span></div>
                <div class="data-item"><span class="data-label">Zodiac (Sidereal)</span><span id="detail-sign" class="data-value"></span></div>
            </div>
        </div>
        
        <!-- NEW: Shamanic & Entheogenic Layers -->
        <div class="panel-section">
            <div class="section-title">Shamanic & Entheogenic Traditions</div>
            <div id="detail-entheo" style="display:flex; flex-direction:column; gap:10px;"></div>
        </div>
        
        <!-- Global Calendrical Layers -->
        <div class="panel-section">
            <div class="section-title">World Calendrical Traditions</div>
            <div id="detail-world-cals" style="display:flex; flex-direction:column; gap:10px;"></div>
        </div>
        
        <!-- Hebridean & Highland Lore -->
        <div class="panel-section">
            <div class="section-title">Hebridean & Highland Lore</div>
            <div id="detail-hebridean" style="font-style:italic;" class="context-box"></div>
        </div>

        <div class="panel-section">
            <div class="section-title">Traditional References</div>
            <div class="context-box"><div class="data-label">Western Folk</div><div id="detail-western" class="serif"></div></div>
            <div class="context-box"><div class="data-label">Mesoamerican (Solar Reconstruction)</div><div id="detail-meso" class="serif"></div></div>
            <div class="context-box"><div class="data-label">Ancient Egyptian (Coptic Approx)</div><div id="detail-egypt" class="serif"></div></div>
        </div>
        
        <div id="detail-deity-section" class="panel-section" style="display:none;">
            <div class="section-title">Deity & Festival Observances</div>
            <div id="detail-deity-list" class="work-list"></div>
        </div>
        
        <div class="panel-section">
            <div class="section-title">Scottish & UK Herbal Harvest</div>
            <div id="detail-scottish-herbs" class="work-list"></div>
        </div>

        <div class="panel-section">
            <div class="section-title">Indigenous Wisdom (Americas)</div>
            <div class="context-box"><div class="data-label">Quero / Andean Traditions</div><div id="detail-quero" class="serif"></div></div>
            <div class="context-box"><div class="data-label">Red Path (Plains/Woodland) Traditions</div><div id="detail-redpath" class="serif"></div></div>
        </div>

        <div class="panel-section">
            <div class="section-title">Cyclic Systems</div>
            <div class="context-box"><div class="data-label">Chinese Lunisolar</div><div id="detail-chinese" class="serif"></div></div>
            <div class="context-box"><div class="data-label">Tibetan Lunisolar</div><div id="detail-tibetan" class="serif"></div></div>
        </div>

        <div class="panel-section">
            <div class="section-title">Celtic & Nature Cycles</div>
            <div class="context-box"><div class="data-label">Seasonal Context (Wheel of the Year)</div><div id="detail-celtic" class="serif"></div></div>
             <div class="context-box"><div class="data-label">Celtic Herbal Harvesting</div><div id="detail-celtic-herbal" style="font-style:italic;"></div></div>
        </div>
        
        <div class="panel-section">
            <div class="section-title">UK Seasonal Foraging (General)</div>
            <div class="context-box"><div class="data-label">Available Herbs (UK Context)</div><div id="detail-uk-herbs" style="font-style:italic;"></div></div>
        </div>

        <div class="panel-section">
            <div class="section-title">Alchemical & Medical</div>
            <div class="data-grid" style="margin-bottom: 12px;">
                <div class="data-item"><span class="data-label">Element (Biodynamic)</span><div style="display:flex; align-items:center; gap:8px;"><span id="detail-elem-icon"></span><span id="detail-elem-name" class="data-value"></span></div></div>
                <div class="data-item"><span class="data-label">Tarot (Golden Dawn)</span><span id="detail-tarot" class="data-value"></span></div>
            </div>
            <div class="context-box"><div class="data-label">Chinese Herbalism (TCM Almanac)</div><div id="detail-tcm" style="font-style:italic;"></div></div>
        </div>
        
        <div class="panel-section">
            <div class="section-title">Ceremonial Context</div>
            <div class="context-box">
                <div class="data-label">Shamanic Traditions (Eurasian/Folk)</div>
                <div id="detail-shamanic" style="font-style:italic;"></div>
            </div>
        </div>

        <div class="panel-section">
            <div class="section-title">Work Suitability & Agriculture</div>
            <div id="work-list" class="work-list"></div>
        </div>

        <div class="panel-section">
            <div class="section-title">Practitioner Notes</div>
            <textarea id="day-note" class="notes-area" placeholder="Record observations..."></textarea>
        </div>
    </aside>

    <div id="bib-panel" class="bib-panel">
        <div class="bib-container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                <h2 class="serif" style="margin:0; font-size: 2rem;">Sources & Traditions Referenced</h2>
                <button id="btn-close-bib" class="close-btn">&times;</button>
            </div>
            <div id="bib-list"></div>
        </div>
    </div>
</div>

<script>
const APP_VERSION = "1.2.0"; // Force reload on update

const Storage = {
    get: (key) => { try { return localStorage.getItem(key); } catch(e) { console.warn("Storage restricted"); return null; } },
    set: (key, val) => { try { localStorage.setItem(key, val); } catch(e) { console.warn("Storage restricted"); } },
    remove: (key) => { try { localStorage.removeItem(key); } catch(e) {} }
};

// Version Check
const currentVer = Storage.get('arc_version');
if (currentVer !== APP_VERSION) {
    Storage.remove('arc_filters'); // Reset filters to ensure new logic applies
    Storage.set('arc_version', APP_VERSION);
    console.log("App updated to version " + APP_VERSION);
}

const DEFAULT_LOGO = "logo.png";
const MOON_PHASES = ["New Moon", "Waxing Crescent", "First Quarter", "Waxing Gibbous", "Full Moon", "Waning Gibbous", "Last Quarter", "Waning Crescent"];
const ZODIAC = ["Aries", "Taurus", "Gemini", "Cancer", "Leo", "Virgo", "Libra", "Scorpio", "Sagittarius", "Capricorn", "Aquarius", "Pisces"];
const WESTERN_NAMES = ["Wolf Moon", "Snow Moon", "Worm Moon", "Pink Moon", "Flower Moon", "Strawberry Moon", "Buck Moon", "Sturgeon Moon", "Corn Moon", "Hunter's Moon", "Beaver Moon", "Cold Moon"];
const TAROT_GD = ["IV The Emperor", "V The Hierophant", "VI The Lovers", "VII The Chariot", "VIII Strength", "IX The Hermit", "XI Justice", "XIII Death", "XIV Temperance", "XV The Devil", "XVII The Star", "XVIII The Moon"];
const VEINTENAS = ["Tititl (Stretching)", "Izcalli (Resurgence)", "Atlacacauallo (Ceasing Water)", "Tlacaxipehualiztli (Flaying)", "Tozoztontli (Little Vigil)", "Huey Tozoztli (Great Vigil)", "Toxcatl (Dryness)", "Etzalcualiztli (Eating Maize)", "Tecuilhuitontli (Small Feast)", "Huey Tecuilhuitl (Great Feast)", "Tlaxochimaco (Flowers)", "Xocotlhuetzi (Fruit Falls)", "Ochpaniztli (Sweeping)", "Teotleco (Arrival)", "Tepeilhuitl (Hill Feast)", "Quecholli (Feather)", "Panquetzaliztli (Banner)", "Atemoztli (Water Descent)", "Nemontemi (Empty)"];

// TIBETAN HAIR CUTTING DATA (Lunar Day 1-30)
const TIBETAN_HAIR = {
    1: { s: "Unfavorable", d: "Shortens life span" },
    2: { s: "Unfavorable", d: "Attracts gossip/slander" },
    3: { s: "Favorable", d: "Increase in wealth" },
    4: { s: "Favorable", d: "Increase in virtue/positive energy" },
    5: { s: "Favorable", d: "Increase in wealth" },
    6: { s: "Favorable", d: "Enhances sensory clarity/complexion" },
    7: { s: "Unfavorable", d: "Legal trouble/lawsuits" },
    8: { s: "Favorable", d: "Promotes longevity" },
    9: { s: "Favorable", d: "Attractive energy" },
    10: { s: "Favorable", d: "Increases personal power/magnetism" },
    11: { s: "Favorable", d: "Increases intelligence" },
    12: { s: "Unfavorable", d: "Loss of wealth/poverty" },
    13: { s: "Favorable", d: "Increase in life span" },
    14: { s: "Favorable", d: "Increase in comfort and resources" },
    15: { s: "Favorable", d: "Generally auspicious" },
    16: { s: "Unfavorable", d: "Obstacles arise" },
    17: { s: "Favorable", d: "Increase in virtue" },
    18: { s: "Unfavorable", d: "Loss of wealth" },
    19: { s: "Favorable", d: "Increase in life span" },
    20: { s: "Unfavorable", d: "Hunger/thirst (spiritual deprivation)" },
    21: { s: "Unfavorable", d: "Susceptibility to illness" },
    22: { s: "Favorable", d: "Gaining food and clothing" },
    23: { s: "Favorable", d: "Increase in wealth" },
    24: { s: "Unfavorable", d: "Risk of infectious disease" },
    25: { s: "Unfavorable", d: "Eye trouble/bad vision" },
    26: { s: "Favorable", d: "Joy and happiness" },
    27: { s: "Favorable", d: "Joy and happiness" },
    28: { s: "Unfavorable", d: "Strife and conflict" },
    29: { s: "Unfavorable", d: "Wandering soul/instability" },
    30: { s: "Unfavorable", d: "Life threatening/speechless" }
};

// Pagan, Witchcraft & Slavic Events (Fixed Dates & Seasonal)
const PAGAN_SLAVIC_DATA = [
    { dates: ["10-31"], name: "Samhain", trad: "Celtic / Pagan", type: "Ancestral / Fire", good: ["Divination", "Ancestor communication", "Ending cycles"], bad: ["Mundane contracts", "Ignoring intuition"], ceremony: "Dumb Supper, Bonfire lighting", icon: "skull", src: "Valiente, ABC of Witchcraft", tag: "celtic" },
    { dates: ["11-2"], name: "Dziady (Ancestors' Eve)", trad: "Old Slavic", type: "Ancestral", good: ["Feeding ancestors", "Cemetery visits", "Remembrance"], bad: ["Housework (sweeping souls away)", "Sewing"], ceremony: "Food offerings, Lighting candles", icon: "skull", src: "Gieysztor, Mythology of the Slavs", tag: "slavic" },
    { dates: ["2-1", "2-2"], name: "Imbolc", trad: "Celtic / Pagan", type: "Purification / Fire", good: ["Cleansing", "Planning", "Candle magic", "Hearth work"], bad: ["Excessive harvesting (Earth sleeping)"], ceremony: "Brigid's Cross, Lighting candles", icon: "spiral", src: "Insular Folklore / Neo-Pagan", tag: "celtic" },
    { dates: ["5-1"], name: "Beltane", trad: "Celtic / Pagan", type: "Fire / Fertility", good: ["Handfasting", "Fire jumping", "Fertility rites", "Protecting livestock"], bad: ["Extinguishing hearth fires without relighting"], ceremony: "Maypole, Bale-fires", icon: "fire", src: "Carmina Gadelica", tag: "celtic" },
    { dates: ["6-23", "6-24"], name: "Kupala Night", trad: "Old Slavic", type: "Fire / Water / Fertility", good: ["Herbal gathering (Fern Flower)", "Love spells", "Purification by fire/water"], bad: ["Sleep (Vigil required)", "Solitude"], ceremony: "Jumping over fire, Floating wreaths", icon: "fire", src: "Gieysztor / Rybakov", tag: "slavic" },
    { dates: ["8-1"], name: "Lughnasadh / Lammas", trad: "Celtic / Pagan", type: "First Harvest", good: ["Bread baking", "Games/Contests", "Gratitude"], bad: ["Hoarding grain"], ceremony: "First loaf offering", icon: "sheaf", src: "Insular Folklore", tag: "celtic" },
    { dates: ["6-21", "6-22"], name: "Litha / Summer Solstice", trad: "Pagan", type: "Solar Peak", good: ["Harvesting magical herbs", "Solar energizing"], bad: ["Darkness/Hiding"], ceremony: "Greeting the Sunrise", icon: "fire", src: "Wheel of the Year", tag: "celtic" },
    { dates: ["12-21", "12-22"], name: "Yule / Szczodre Gody", trad: "Pagan / Slavic", type: "Solar Rebirth", good: ["Feasting", "Evergreen decoration", "Hope"], bad: ["Extinguishing light"], ceremony: "Yule Log, Koliada singing", icon: "fire", src: "Wheel of the Year / Slavic Custom", tag: "slavic" }
];

// BALKAN FOLK CALENDAR (Fixed)
const BALKAN_DATA = [
    { dates: ["3-1"], name: "Baba Marta", trad: "Balkan Folk", type: "Seasonal Threshold", good: ["Wearing red/white martnitsa for health"], bad: [], ceremony: "Giving Martenitsa", icon: "wheat", src: "Bulgarian Folklore", tag: "balkan" },
    { dates: ["5-6"], name: "St. George (Gergyovden)", trad: "Balkan/Slavic", type: "Agricultural", good: ["Lamb sacrifice", "Measuring flocks"], bad: [], ceremony: "Ritual bread, Green boughs", icon: "sheaf", src: "South Slavic Tradition", tag: "balkan" },
    { dates: ["6-24"], name: "Enyovden", trad: "Balkan Folk", type: "Solar/Herbal", good: ["Herbal harvest at sunrise"], bad: ["Working in fields"], ceremony: "Walking on dew", icon: "fire", src: "Bulgarian/Thracian Tradition", tag: "balkan" }
];

// ANDEAN / QUECHUA FIXED EVENTS
const ANDEAN_FIXED_DATA = [
    { dates: ["5-3"], name: "Chakana Day (Cruz Velacuy)", trad: "Andean/Quechua", type: "Cosmological", good: ["Aligning with the Southern Cross", "Community offerings"], bad: [], ceremony: "Adorning the cross", icon: "chakana", src: "Ethnographic Record / Sharon" },
    { dates: ["6-24"], name: "Inti Raymi", trad: "Andean/Quechua", type: "Solar Festival", good: ["Honoring the Sun", "New agricultural year"], bad: [], ceremony: "Solar offerings", icon: "chakana", src: "Historical / Reconstructed" },
    { dates: ["8-1"], name: "Pachamama Raymi", trad: "Andean/Quechua", type: "Earth Honoring", good: ["Making Despacho offerings", "Payment to the Earth"], bad: ["Taking from the earth without asking"], ceremony: "Despacho / Pago a la Tierra", icon: "chakana", src: "Andean Cosmology / Q'espi" }
];

// NEW: Scottish & UK Herbal Harvest Calendar
const SCOTTISH_HERB_DATA = [
    { name: "Stinging Nettle", part: "Leaf", months: [1,2,3,4], phase: "Waxing", note: "Gather young tops for iron-rich spring tonic." },
    { name: "Cleavers (Sticky Willie)", part: "Leaf/Stem", months: [2,3,4], phase: "Waxing", note: "Spring tonic, lymphatic cleanser." },
    { name: "Dandelion", part: "Leaf", months: [2,3,4], phase: "Waxing", note: "Young leaves before flowering." },
    { name: "Dandelion", part: "Root", months: [8,9,10], phase: "Waning", note: "Dig in autumn when energy returns to root." },
    { name: "Meadowsweet", part: "Flower", months: [5,6,7], phase: "Waxing", note: "Sacred druidic herb. Harvest open flowers." },
    { name: "Yarrow", part: "Flower/Leaf", months: [5,6,7,8], phase: "Waxing", note: "Woundwort. Gather on sunny days." },
    { name: "St John's Wort", part: "Flower", months: [5,6,7], phase: "Full", note: "Protection against spirits. Harvest at peak sun." },
    { name: "Elder", part: "Flower", months: [4,5,6], phase: "Waxing", note: "Do not burn the wood. Creamy white blooms." },
    { name: "Elder", part: "Berry", months: [7,8,9], phase: "Waning", note: "Cook before use. Rich in Vitamin C." },
    { name: "Hawthorn", part: "Berry (Haws)", months: [8,9,10], phase: "Waning", note: "Heart tonic. Wait for deep red color." },
    { name: "Rowan", part: "Berry", months: [8,9,10], phase: "Waning", note: "Protection charm. Jelly making." },
    { name: "Rosehip", part: "Berry", months: [8,9,10], phase: "Waning", note: "Vitamin C source. Harvest after first frost for sweetness." },
    { name: "Burdock", part: "Root", months: [9,10,11], phase: "Waning", note: "Deep digging required. First year roots." },
    { name: "Scots Pine", part: "Resin/Needle", months: [11,0,1], phase: "Any", note: "Winter harvest. Rich in Vitamin C." }
];

const MERCURY_RETROGRADE = [
    { start: "11-25-2024", end: "12-15-2024" },
    { start: "3-15-2025", end: "4-7-2025" },
    { start: "7-18-2025", end: "8-11-2025" },
    { start: "11-9-2025", end: "11-29-2025" }
];

const BIBLIOGRAPHY = [
    { title: "Tibetan Lunar Astrology", meta: "Tibetan Medical & Astrological Institute (Men-Tsee-Khang). Hair cutting days based on traditional lunar day correspondences." },
    { title: "Hebridean & Highland Lore", meta: "F. Marian McNeill, 'The Silver Bough'; Alexander Carmichael, 'Carmina Gadelica'. Fishing and crofting moon lore." },
    { title: "Scottish Folk Herbalism", meta: "Tess Darwin, 'The Scots Herbal'; Traditional practice. Seasonality and lunar timing for harvest." },
    { title: "Witchcraft / Pagan Traditions", meta: "Doreen Valiente, 'ABC of Witchcraft'; Gerald Gardner, 'Witchcraft Today'. Wheel of the Year observances." },
    { title: "Hebrew Calendar Tradition", meta: "Non-devotional calendrical timing. Arthur Spier, 'The Comprehensive Hebrew Calendar'. Agricultural and reflective cycles." },
    { title: "Vedic Panchang", meta: "Traditional Indian Astrology. B.V. Raman, 'Muhurtha'. Tithi and Nakshatra suitability logic." },
    { title: "Mesoamerican Calendrics", meta: "The Tzolk'in Count (GMT Correlation). Barbara Tedlock, 'Time and the Highland Maya'. Day energy and divination." },
    { title: "African Traditional Calendars", meta: "Generalized Yoruba (4-day) and Akan (42-day) cycles. John Mbiti, 'African Religions & Philosophy'. Sacred vs Mundane timing." },
    { title: "Balkan/Slavic Folk Calendar", meta: "Éva Pócs, 'Fairies and Witches at the Boundary'. Folk calendrical survivals and agrarian taboos." },
    { title: "Andean / Quechua Shamanism", meta: "Ethnographic records. Douglas Sharon, 'Wizard of the Four Winds'. Ceremonial timing and offerings." },
    { title: "Amazonian / Ayahuasca Traditions", meta: "Reichel-Dolmatoff, 'The Shaman and the Jaguar'; Luna & Amaringo. Lunar purging cycles." },
    { title: "Ceremonial Mushroom Traditions", meta: "R. Gordon Wasson; Richard Evans Schultes. Mazatec and Northwest indigenous harvest windows." },
    { title: "Old Slavic Traditions", meta: "Aleksander Gieysztor, 'Mythology of the Slavs'. Calendar customs (Kupala, Dziady)." },
    { title: "Celtic Traditions", meta: "Kevin Danaher, 'The Year in Ireland'. Folk customs and festivals." },
    { title: "Biodynamic Agriculture", meta: "Maria Thun, 'The Biodynamic Sowing and Planting Calendar'. 20th C. Anthroposophic tradition." },
    { title: "Western Alchemical/Herbal", meta: "Paracelsus, Culpeper. Renaissance traditions associating lunar phases with fluid dynamics." },
    { title: "Chinese Calendrics & TCM", meta: "Traditional Sexagenary Cycle (Gan-Zhi) & TCM Almanacs." },
    { title: "Egyptian Calendar", meta: "Reconstructed Civil Calendar. 365 days." },
    { title: "Tarot Correspondences", meta: "Hermetic Order of the Golden Dawn (Late 19th C). 'Book T'." },
    { title: "Mesoamerican Veintenas", meta: "Bernardino de Sahagún, 'Florentine Codex'. 16th C." },
    { title: "Shamanic Traditions (Eurasian)", meta: "General Eurasian and Folk traditions regarding lunar ceremonial timing." },
    { title: "Quero / Andean Tradition", meta: "Don Manuel Q'espi, Andean Cosmology." },
    { title: "Red Path Traditions", meta: "General Lakota/Plains/Woodland customs." },
    { title: "Deity/Festival Sources", meta: "WFT Academy of Pagan Studies, Wikipedia, Buddha Weekly." },
    { title: "Islamic Lunar Calendar", meta: "Hijri Calendar (Umm al-Qura). White Days fasting traditions." },
    { title: "Roman Calendar", meta: "Reconstructed Julian Calendar structure (Kalends, Nones, Ides)." },
    { title: "Anglo-Saxon Calendar", meta: "Bede, 'De temporum ratione'. Historical month names." }
];

const UK_HERBS = [
    { name: "Stinging Nettle", latin: "Urtica dioica", part: "Leaf", months: [1,2,3,4], note: "Harvest young tops before flowering.", source: "wildfoodie.co.uk" },
    { name: "Cleavers", latin: "Galium aparine", part: "Leaf", months: [2,3,4], note: "Harvest young stems for tonics.", source: "betonica.co.uk" },
    { name: "Dandelion", latin: "Taraxacum officinale", part: "Leaf", months: [2,3,4], note: "Young leaves before flower stalks appear.", source: "RHS" },
    { name: "Dandelion", latin: "Taraxacum officinale", part: "Root", months: [8,9,10], note: "Harvest in autumn when inulin is high.", source: "RHS" },
    { name: "Hawthorn", latin: "Crataegus monogyna", part: "Leaf/Flower", months: [3,4], note: "Young leaves and flowering tops.", source: "wildfoodie.co.uk" },
    { name: "Hawthorn", latin: "Crataegus monogyna", part: "Fruit", months: [8,9,10], note: "Berries (Haws) fully red.", source: "wildfoodie.co.uk" },
    { name: "Elder", latin: "Sambucus nigra", part: "Flower", months: [4,5,6], note: "Fully open creamy heads on sunny days.", source: "wildfoodie.co.uk" },
    { name: "Elder", latin: "Sambucus nigra", part: "Fruit", months: [7,8,9], note: "Fully black berries, cook before use.", source: "wildfoodie.co.uk" },
    { name: "St John's Wort", latin: "Hypericum perforatum", part: "Flower", months: [5,6,7], note: "Harvest flowering tops around Midsummer.", source: "betonica.co.uk" },
    { name: "Meadowsweet", latin: "Filipendula ulmaria", part: "Flower", months: [5,6,7], note: "Flowering tops.", source: "RHS" },
    { name: "Yarrow", latin: "Achillea millefolium", part: "Leaf/Flower", months: [5,6,7,8,9], note: "Flowering tops and leaves.", source: "RHS" },
    { name: "Rose", latin: "Rosa canina", part: "Flower", months: [5,6,7], note: "Petals.", source: "wildfoodie.co.uk" },
    { name: "Rose", latin: "Rosa canina", part: "Fruit", months: [8,9,10], note: "Hips, after first frost implies sweetness.", source: "wildfoodie.co.uk" },
    { name: "Burdock", latin: "Arctium lappa", part: "Root", months: [8,9,10,11,0,1,2], note: "First year roots in autumn/winter.", source: "betonica.co.uk" },
    { name: "Sloe (Blackthorn)", latin: "Prunus spinosa", part: "Fruit", months: [9,10,11], note: "Harvest after first frost.", source: "wildfoodie.co.uk" },
    { name: "Chickweed", latin: "Stellaria media", part: "Leaf", months: [0,1,2,3,4,5,6,7,8,9,10,11], note: "Available year round, best in cool seasons.", source: "rvs.umn.edu" }
];

const WEEKDAY_CORRESPONDENCE = [
    { day: "Sunday", planet: "Sun", element: "fire" },
    { day: "Monday", planet: "Moon", element: "water" },
    { day: "Tuesday", planet: "Mars", element: "fire" },
    { day: "Wednesday", planet: "Mercury", element: "air" },
    { day: "Thursday", planet: "Jupiter", element: "air" },
    { day: "Friday", planet: "Venus", element: "earth" },
    { day: "Saturday", planet: "Saturn", element: "earth" }
];

const CELTIC_FESTIVALS = {
    "2-1": "Imbolc (Brigid's Day)",
    "5-1": "Beltane (First Summer)",
    "8-1": "Lughnasadh (First Harvest)",
    "10-31": "Samhain (New Year / Ancestors)",
    "3-20": "Spring Equinox (Ostara)",
    "6-21": "Summer Solstice (Litha)",
    "9-22": "Autumn Equinox (Mabon)",
    "12-21": "Winter Solstice (Yule)"
};

const DEITY_FESTIVALS = [
    { start: "8-12", end: "8-12", name: "The Lights of Isis", deity: "Isis", source: "WFT Academy of Pagan Studies", type: "Egyptian", icon: "ankh" },
    { start: "8-29", end: "9-11", name: "Return of Isis & Osiris", deity: "Isis & Osiris", source: "WFT Academy of Pagan Studies", type: "Egyptian", icon: "ankh" },
    { start: "11-10", end: "12-9", name: "Month of Hathor", deity: "Hathor", source: "Wikipedia", type: "Egyptian", icon: "ankh" },
    { start: "11-2", end: "11-2", name: "Festival of Hathor", deity: "Hathor", source: "WFT Academy of Pagan Studies", type: "Egyptian", icon: "ankh" },
    { start: "11-29", end: "11-29", name: "Feast of Hathor / Bast-Hathor-Sekhmet", deity: "Hathor", source: "WFT Academy of Pagan Studies", type: "Egyptian", icon: "ankh" },
    { start: "3-25", end: "3-25", name: "Feast of the Annunciation", deity: "Maria", source: "Holidays and Observances", type: "Christian", icon: "star" },
    { start: "8-15", end: "8-15", name: "Assumption of Mary", deity: "Mary", source: "Massachusetts State Archives", type: "Christian", icon: "star" },
    { start: "12-12", end: "12-12", name: "Fiesta of Our Lady of Guadalupe", deity: "Mary", source: "WFT Academy of Pagan Studies", type: "Christian", icon: "star" },
    { start: "7-22", end: "7-22", name: "Feast of Saint Mary Magdalene", deity: "Mary Magdalene", source: "Wikipedia", type: "Christian", icon: "star" },
    { start: "7-3-2025", end: "7-3-2025", name: "Green Tara & Medicine Buddha Day", deity: "Green Tara", source: "Facebook (Tsurphu)", type: "Buddhist", icon: "lotus" },
    { start: "8-1-2025", end: "8-1-2025", name: "Green Tara & Medicine Buddha Day", deity: "Green Tara", source: "Facebook (Tsurphu)", type: "Buddhist", icon: "lotus" }
];

function getJulianDate(date) { return (date.getTime() / 86400000) + 2440587.5; }
function normalize(d) { let a = d % 360; if (a < 0) a += 360; return a; }

// Updated for Vedic Calculations
function getMoonData(date) {
    const jd = getJulianDate(date);
    const T = (jd - 2451545.0) / 36525;
    const L0 = 218.316 + 481267.8813 * T;
    const M = 134.963 + 477198.8676 * T;
    const D = 297.850 + 445267.1115 * T;
    const M_sun = 357.528 + 35999.0503 * T;
    let Long = L0 + 6.289 * Math.sin(M * Math.PI/180) - 1.274 * Math.sin((M - 2*D) * Math.PI/180) + 0.658 * Math.sin(2*D * Math.PI/180) - 0.186 * Math.sin(M_sun * Math.PI/180);
    Long = normalize(Long);

    // Approximate Sun Longitude for Tithi
    // Mean Longitude of Sun = L0_sun
    const L0_sun = 280.466 + 36000.7698 * T;
    const SunLong = normalize(L0_sun + 1.915 * Math.sin(M_sun * Math.PI/180) + 0.020 * Math.sin(2 * M_sun * Math.PI/180));

    const knownNew = 2451550.1;
    const synodic = 29.53058867;
    const ageRaw = (jd - knownNew) % synodic;
    const age = ageRaw < 0 ? ageRaw + synodic : ageRaw;
    
    let phaseIdx = 0;
    if (age < 1 || age > 28.5) phaseIdx = 0;
    else if (age < 6.4) phaseIdx = 1;
    else if (age < 8.4) phaseIdx = 2;
    else if (age < 13.8) phaseIdx = 3;
    else if (age < 15.8) phaseIdx = 4;
    else if (age < 21.1) phaseIdx = 5;
    else if (age < 23.1) phaseIdx = 6;
    else phaseIdx = 7;

    const illum = 50 * (1 - Math.cos((age / synodic) * 2 * Math.PI));
    const siderealLong = normalize(Long - 24);
    const signIdx = Math.floor(siderealLong / 30);

    return { age, phaseIdx, phaseName: MOON_PHASES[phaseIdx], illum: Math.round(illum), sign: ZODIAC[signIdx], signIdx, long: Long, sunLong: SunLong, siderealLong, jd };
}

function getDayOfYear(date) { const start = new Date(date.getFullYear(), 0, 0); const diff = date - start; return Math.floor(diff / (1000 * 60 * 60 * 24)); }

function getBiodynamic(signIdx) {
    const types = ["Fruit", "Root", "Flower", "Leaf"];
    const elems = ["fire", "earth", "air", "water"];
    const idx = signIdx % 4;
    return { type: types[idx], element: elems[idx] };
}
function getWeekdayData(date) { return WEEKDAY_CORRESPONDENCE[date.getDay()]; }

function getCelticData(date, doy) {
    const key = `${date.getMonth()+1}-${date.getDate()}`;
    const festival = CELTIC_FESTIVALS[key];
    const seasons = ["Winter", "Spring", "Summer", "Autumn"];
    const q = Math.floor((doy + 10) / 91) % 4;
    return { name: festival || `Solar Day ${doy}`, festival: festival, season: seasons[q], isFestival: !!festival };
}

function getDeityEvents(date, moon) {
    const events = [];
    const m = date.getMonth() + 1, d = date.getDate(), y = date.getFullYear();
    const tibetanDay = Math.floor(moon.age) + 1;
    
    DEITY_FESTIVALS.forEach(f => {
        const pStart = f.start.split('-').map(Number);
        const pEnd = f.end.split('-').map(Number);
        let isMatch = false;
        if (pStart.length === 3) { if (pStart[2] === y && pStart[0] === m && pStart[1] === d) isMatch = true; } 
        else { const curVal = m * 100 + d; const startVal = pStart[0] * 100 + pStart[1]; const endVal = pEnd[0] * 100 + pEnd[1]; if (startVal <= endVal) { if (curVal >= startVal && curVal <= endVal) isMatch = true; } else { if (curVal >= startVal || curVal <= endVal) isMatch = true; } }
        if (isMatch) events.push(f);
    });

    if (tibetanDay === 8) events.push({ name: "Green Tara Day", deity: "Green Tara", source: "Buddha Weekly", type: "Buddhist", icon: "lotus", note: "Exalted in Vajrayana Tibetan tradition (8th lunar day)." });
    if (tibetanDay === 19) events.push({ name: "Quan Yin Day (Check Month)", deity: "Quan Yin", source: "Wing Hop Fung 永合豐", type: "Buddhist", icon: "lotus", note: "Celebration days on 19th lunar days of 2nd, 6th, and 9th months." });
    return events;
}

function getPaganSlavicEvents(date, doy) {
    const key = `${date.getMonth()+1}-${date.getDate()}`;
    const events = PAGAN_SLAVIC_DATA.filter(e => e.dates.includes(key));
    const balkan = BALKAN_DATA.filter(e => e.dates.includes(key));
    const all = [...events, ...balkan];
    
    // Add Solstice/Equinox Logic based on DOY ranges if not covered by fixed dates
    if (doy >= 79 && doy <= 81 && !all.some(e=>e.name.includes("Ostara"))) all.push({ name: "Ostara / Jare Gody (Equinox)", trad: "Pagan / Slavic", type: "Balance / Spring", good: ["New beginnings", "Planting", "Cleaning"], bad: ["Stagnation"], ceremony: "Egg painting, Marzanna drowning", icon: "spiral", src: "Seasonal", tag: "slavic" });
    if (doy >= 171 && doy <= 173 && !all.some(e=>e.name.includes("Litha"))) all.push({ name: "Litha / Kupala (Solstice)", trad: "Pagan / Slavic", type: "Solar Peak", good: ["Herbal harvest", "Fire magic"], bad: ["Darkness"], ceremony: "Bonfires", icon: "fire", src: "Seasonal", tag: "slavic" });
    if (doy >= 264 && doy <= 266 && !all.some(e=>e.name.includes("Mabon"))) all.push({ name: "Mabon / Dożynki (Equinox)", trad: "Pagan / Slavic", type: "Harvest Balance", good: ["Feasting", "Gratitude"], bad: ["Waste"], ceremony: "Harvest wreath", icon: "sheaf", src: "Seasonal", tag: "slavic" });
    if (doy >= 354 && doy <= 356 && !all.some(e=>e.name.includes("Yule"))) all.push({ name: "Yule / Szczodre Gody (Solstice)", trad: "Pagan / Slavic", type: "Return of Light", good: ["Feasting", "Rest"], bad: ["Extinguishing fire"], ceremony: "Yule Log", icon: "fire", src: "Seasonal", tag: "slavic" });

    return all;
}

// === NEW CALENDRICAL FUNCTIONS ===

function getHebrewData(date, moon) {
    const formatter = new Intl.DateTimeFormat('en-u-ca-hebrew', {month: 'long', day: 'numeric', year: 'numeric'});
    const hebrewDateStr = formatter.format(date);
    const dayMatch = hebrewDateStr.match(/(\d+),/);
    const hDay = dayMatch ? parseInt(dayMatch[1]) : 1;
    let good = [], bad = [], note = "";
    if (date.getDay() === 6) { note += "Shabbat (Rest). "; good.push({txt: "Rest, Reflection, Study", src: "Hebrew Calendar"}); bad.push({txt: "Commerce, Travel, Creative Work", src: "Hebrew Calendar"}); }
    if (hDay === 1 || hDay === 30) { note += "Rosh Chodesh (New Moon). "; good.push({txt: "Renewal, Women's Circles", src: "Hebrew Calendar"}); }
    return { date: hebrewDateStr, note, good, bad };
}

function getIslamicData(date) {
    const formatter = new Intl.DateTimeFormat('en-u-ca-islamic-umalqura', {month: 'long', day: 'numeric', year: 'numeric'});
    const islStr = formatter.format(date);
    const dayMatch = islStr.match(/(\d+),/);
    const iDay = dayMatch ? parseInt(dayMatch[1]) : 1;
    let note = "";
    if ([13, 14, 15].includes(iDay)) note = "White Days (Ayyam al-Bid) - Recommended Fasting";
    return { date: islStr, note };
}

function getRomanData(date) {
    const d = date.getDate();
    const m = date.getMonth(); // 0-11
    // Mar(2), May(4), Jul(6), Oct(9): Nones 7, Ides 15
    const isLate = [2, 4, 6, 9].includes(m);
    const nones = isLate ? 7 : 5;
    const ides = isLate ? 15 : 13;
    let type = "";
    if (d === 1) type = "Kalends";
    else if (d === nones) type = "Nones";
    else if (d === ides) type = "Ides";
    return { type };
}

function getAngloSaxonData(date) {
    const months = ["After Yule", "Solmonath (Mud Month)", "Hrethmonath", "Eostremonath", "Thrimilci (Three Milk)", "Lida (Mild)", "Lida (Mild)", "Weodmonath (Plant Month)", "Haligmonath (Holy Month)", "Winterfylleth", "Blodmonath (Blood Month)", "Before Yule"];
    return { month: months[date.getMonth()] };
}

function getVedicData(moon) {
    let diff = normalize(moon.long - moon.sunLong);
    let tithiVal = diff / 12;
    let tithiNum = Math.floor(tithiVal) + 1; // 1-30
    let paksha = tithiNum <= 15 ? "Shukla (Waxing)" : "Krishna (Waning)";
    let tithiName = tithiNum <= 15 ? `Shukla ${tithiNum}` : `Krishna ${tithiNum - 15}`;
    if (tithiNum === 15) tithiName = "Purnima (Full)";
    if (tithiNum === 30) tithiName = "Amavasya (New)";
    let nakVal = moon.siderealLong / 13.3333;
    let nakNum = Math.floor(nakVal) + 1; // 1-27
    let good = [], bad = [];
    if (tithiNum === 30) { bad.push({txt: "Material Initiation, Travel", src: "Vedic Panchang (Amavasya)"}); good.push({txt: "Ancestor Rituals (Pitru)", src: "Vedic Panchang"}); }
    if (tithiNum === 15) { good.push({txt: "Satvic Rituals, Meditation", src: "Vedic Panchang (Purnima)"}); }
    if ([4, 9, 14, 19, 24, 29].includes(tithiNum)) { bad.push({txt: "Important Material Beginnings", src: "Vedic Panchang (Rikta Tithi)"}); good.push({txt: "Cleansing, Surgery, Debate", src: "Vedic Panchang"}); }
    return { tithi: tithiName, paksha, nakshatra: `Nakshatra ${nakNum}`, good, bad };
}

function getMesoamericanData(moon) {
    const jd = Math.floor(moon.jd + 0.5);
    const passed = jd - 584283;
    const tzolkinDay = (passed % 260 + 260) % 260;
    const number = (tzolkinDay % 13) + 1;
    const nameIdx = (tzolkinDay % 20); // 0-19
    const dayNames = ["Imix", "Ik'", "Ak'b'al", "K'an", "Chikchan", "Kimi", "Manik'", "Lamat", "Muluk", "Ok", "Chuwen", "Eb'", "B'en", "Ix", "Men", "Kib'", "Kab'an", "Etz'nab'", "Kawak", "Ajaw"];
    const dayName = dayNames[nameIdx];
    let note = "";
    if (["Imix", "K'an", "Ajaw"].includes(dayName)) note = "Traditionally favorable for seeding intentions.";
    if (["Kimi", "Etz'nab'"].includes(dayName)) note = "Traditionally associated with transformation/release.";
    return { long: `${number} ${dayName}`, note };
}

function getAfricanData(date) {
    const base = new Date(2024, 0, 1).getTime();
    const diff = date.getTime() - base;
    const days = Math.floor(diff / (1000*60*60*24));
    const cycle = ((days % 4) + 4) % 4 + 1; // 1-4
    let desc = "";
    if(cycle === 1) desc = "Day 1 (Creation/Divination archetype)";
    if(cycle === 2) desc = "Day 2 (Commerce/Market archetype)";
    if(cycle === 3) desc = "Day 3 (Adversity/War archetype)";
    if(cycle === 4) desc = "Day 4 (Rest/Ancestors archetype)";
    return { cycle: `4-Day Cycle: ${cycle}`, desc };
}

// === NEW SHAMANIC FUNCTIONS ===

function getAndeanLogic(date, moon, doy) {
    const key = `${date.getMonth()+1}-${date.getDate()}`;
    const fixed = ANDEAN_FIXED_DATA.find(f => f.dates.includes(key));
    let good = [], bad = [], ceremony = [], note = "";
    if (fixed) { fixed.good.forEach(g => good.push({txt: g, src: fixed.src})); fixed.bad.forEach(b => bad.push({txt: b, src: fixed.src})); ceremony.push(`${fixed.name}: ${fixed.ceremony}`); }
    if (moon.phaseIdx === 4) { ceremony.push("Junta Quilla (Full Moon Offering)"); good.push({txt: "Making Ayni (reciprocity) offerings", src: "Andean Cosmology"}); }
    if (moon.phaseIdx === 0) { ceremony.push("Musuq Quilla (New Moon Intention)"); good.push({txt: "Saminchakuy (Refining/Cleansing)", src: "Andean Cosmology"}); }
    return { good, bad, ceremony, fixed };
}

function getEntheogenLogic(date, moon) {
    let aya = { good: [], bad: [], note: "" };
    if (moon.phaseIdx === 0) { aya.note = "New Moon: Deep Purging / Dieta Start."; aya.good.push({txt: "Starting Master Plant Dietas", src: "Amazonian/Shipibo Tradition"}); aya.good.push({txt: "Purification/La Purga", src: "Amazonian/Shipibo Tradition"}); } 
    else if (moon.phaseIdx === 4) { aya.note = "Full Moon: High Visionary Energy."; aya.good.push({txt: "Visionary Ceremonies", src: "Amazonian/Asháninka Tradition"}); aya.bad.push({txt: "Chaotic settings (Energy amplification)", src: "Amazonian Tradition"}); }
    
    const m = date.getMonth(); // 0-11
    const day = date.getDay(); // 0 (Sun) - 6 (Sat)
    
    let mush = { good: [], bad: [], note: "" };
    
    // MAZATEC / MESOAMERICAN LOGIC
    // Rainy Season (Approx May-Oct in Oaxaca/Highlands)
    const isRainySeason = (m >= 4 && m <= 9); // May (4) to Oct (9)
    const isWeekend = (day === 5 || day === 6); // Fri or Sat
    const isMajorPhase = (moon.phaseIdx === 0 || moon.phaseIdx === 4 || moon.phaseIdx === 2 || moon.phaseIdx === 6);
    
    // Moon Phase Logic for Mushrooms
    let phaseGuidance = "";
    if (moon.phaseIdx === 4) phaseGuidance = "Full Moon: High-energy communal ceremonies, divination, healing.";
    else if (moon.phaseIdx === 0) phaseGuidance = "New Moon: Introspection, personal purification, intention setting.";
    else if (moon.phaseIdx >= 1 && moon.phaseIdx <= 3) phaseGuidance = "Waxing Moon: Growth, starting new projects, spiritual learning.";
    else if (moon.phaseIdx >= 5 && moon.phaseIdx <= 7) phaseGuidance = "Waning Moon: Release, letting go, cleansing, integration.";

    // Apply Mazatec logic only during season and on preferred days/phases
    // STRICT ASSIGNMENT: Day must be Season AND (Weekend OR Major Phase) for specific mushroom icon
    if (isRainySeason && (isWeekend || isMajorPhase)) {
        let note = "Mazatec Rainy Season (Time of the Little Ones). " + phaseGuidance;
        if (isWeekend) note += " Traditional preference for Friday/Saturday night Veladas.";
        
        mush.note = note;
        mush.good.push({txt: "Traditional Velada (Night Vigil)", src: "Mazatec Tradition"});
        mush.good.push({txt: "Consulting dreams/omens before scheduling", src: "Mazatec/Indigenous Advisory"});
    } else if (isRainySeason) {
        // In season but off-peak day
        mush.note = ""; // No strict icon assignment for random Tuesday unless explicit
    } else {
        // Off season
        mush.note = "";
    }

    const key = `${date.getMonth()+1}-${date.getDate()}`;
    if (key === "6-29") { mush.note = "San Pedro & San Pablo Day. " + phaseGuidance; mush.good.push({txt: "Ceremonial gathering (Syncretic)", src: "Highland Mexico Tradition"}); }
    
    // Harvest windows imply ceremonial availability
    if (m >= 9 && m <= 11) { 
        mush.good.push({txt: "Amanita Harvest Window (Northern Hemisphere)", src: "Indigenous Northwest/Siberian"}); 
        // Strict logic: If in harvest window, we consider it a 'valid' day for icon consideration if phase aligns
        if (isMajorPhase) mush.note = "Harvest Season (Northern). " + phaseGuidance;
    }
    
    // Northwest / California Logic
    if (m >= 9 && m <= 11) { mush.good.push({txt: "Northwest / California: Autumn Coastal Harvest", src: "Indigenous Northwest Traditions"}); }
    
    // Caribbean / Tropical Logic
    if (moon.phaseIdx === 4 || moon.phaseIdx === 0) { mush.good.push({txt: "Caribbean / Tropical: High Humidity Growth", src: "Amazon/Caribbean Folk Tradition"}); }
    
    return { aya, mush };
}

function getHebrideanGuidance(moon) {
    const isWaxing = moon.phaseIdx >= 1 && moon.phaseIdx <= 4;
    const isFull = moon.phaseIdx === 4;
    const isWaning = moon.phaseIdx > 4 || moon.phaseIdx === 7;
    const isDark = moon.phaseIdx === 0;
    let fish = { status: "Neutral", desc: "" }; let croft = { status: "Neutral", desc: "" }; let good = [], bad = [];
    if (isWaxing) { fish = { status: "Good", desc: "Waxing Moon draws the fish (Highland Lore)." }; good.push({ txt: "General fishing", src: "Hebridean Folklore" }); } 
    else if (isFull) { fish = { status: "Caution", desc: "Bright nights, strong tides (Springs)." }; good.push({ txt: "Shore gathering (Low Spring Tides)", src: "Hebridean Folklore" }); bad.push({ txt: "Fishing in strong currents", src: "Hebridean Folklore" }); } 
    else if (isWaning) { fish = { status: "Fair", desc: "Preserve catch, repair nets." }; good.push({ txt: "Net repair & Curing", src: "Hebridean Folklore" }); } 
    else if (isDark) { fish = { status: "Avoid", desc: "Dark Moon - avoid the sea." }; bad.push({ txt: "Sea voyages", src: "Hebridean Folklore" }); }
    if (isWaxing || isFull) { croft = { status: "Sowing", desc: "Plant above-ground crops." }; good.push({ txt: "Planting oats/barley", src: "Scottish Crofting Tradition" }); } 
    else { croft = { status: "Harvest", desc: "Harvest roots, cut peat." }; good.push({ txt: "Peat cutting & Root harvest", src: "Scottish Crofting Tradition" }); }
    return { fish, croft, good, bad };
}

function getScottishHerbs(date, moon) {
    const m = date.getMonth(); const available = SCOTTISH_HERB_DATA.filter(h => h.months.includes(m));
    const isWaxing = moon.phaseIdx >= 1 && moon.phaseIdx <= 4;
    const isWaning = moon.phaseIdx > 4 || moon.phaseIdx === 0;
    const isFull = moon.phaseIdx === 4;
    const suitable = available.map(h => {
        let match = false;
        if (h.phase === "Any") match = true; else if (h.phase === "Waxing" && isWaxing) match = true; else if (h.phase === "Waning" && isWaning) match = true; else if (h.phase === "Full" && isFull) match = true;
        return { ...h, suitable: match };
    });
    return suitable;
}

function getCelticHerbalData(date, moon) {
    const key = `${date.getMonth()+1}-${date.getDate()}`;
    if (Math.floor(moon.age) === 6) return { plant: "Mistletoe (Uil-ice)", action: "Sacred Cutting (Golden Sickle)", source: "Pliny the Elder, Naturalis Historia XVI" };
    if (key === "6-21" || key === "6-23" || key === "6-24") return { plant: "St. John's Wort / Vervain", action: "Gathering for Protection", source: "Insular Folklore / Carmina Gadelica" };
    if (key === "8-1" || key === "8-2") return { plant: "Bilberries (Fraoch)", action: "First Fruit Gathering", source: "Lughnasadh Folk Tradition" };
    if (key === "5-1") return { plant: "Nettle / Hawthorn", action: "Gathering Green", source: "Beltane Tradition" };
    if (key === "10-31") return { plant: "Mugwort / Roots", action: "Divination Harvest", source: "Samhain Folk Tradition" };
    if (moon.phaseIdx === 1 || moon.phaseIdx === 3) return { plant: "Aerial Parts", action: "General Leaf Harvest (Waxing)", source: "General Folk Practice" };
    if (moon.phaseIdx === 5 || moon.phaseIdx === 7) return { plant: "Roots", action: "General Root Harvest (Waning)", source: "General Folk Practice" };
    return { plant: "", action: "", source: "" };
}

function getUKForaging(date) {
    const m = date.getMonth();
    const available = UK_HERBS.filter(h => h.months.includes(m));
    const types = [...new Set(available.map(h => { if (h.part.includes("Leaf")) return "Leaf"; if (h.part.includes("Flower")) return "Flower"; if (h.part.includes("Fruit")) return "Fruit"; if (h.part.includes("Root")) return "Root"; return "Plant"; }))];
    return { available, types };
}

function getChineseGuidance(moon) {
    if (moon.phaseIdx === 0 || moon.age > 28) return { guidance: "Yin Peak: Harvest Roots. Avoid active preparation.", source: "Traditional Chinese Medicine Almanac", type: "Harvesting (Yin)" };
    if (moon.phaseIdx >= 1 && moon.phaseIdx <= 3) return { guidance: "Growing Yang: Prepare Tonics. Harvest Leaves & Stems.", source: "Traditional Chinese Medicine Almanac", type: "Preparation/Harvest (Yang)" };
    if (moon.phaseIdx === 4) return { guidance: "Yang Peak: Most Potent Harvest (Flowers/Fruits).", source: "Traditional Chinese Medicine Almanac", type: "Harvesting (Yang Peak)" };
    return { guidance: "Growing Yin: Prepare Cleansers. Harvest Bark/Roots.", source: "Traditional Chinese Medicine Almanac", type: "Preparation/Harvest (Yin)" };
}

function getShamanicData(moon) {
    if (moon.phaseIdx === 0) return { ceremony: "Divination / Ancestral", desc: "Dark Moon: Scrying, interacting with the Lower World, stillness.", source: "Eurasian Shamanic Traditions" };
    if (moon.phaseIdx === 1) return { ceremony: "Invocation", desc: "New Crescent: Calling in spirits, seeding intention.", source: "Eurasian Shamanic Traditions" };
    if (moon.phaseIdx === 2) return { ceremony: "Initiation", desc: "First Quarter: Crossing thresholds, action ceremonies.", source: "Eurasian Shamanic Traditions" };
    if (moon.phaseIdx === 4) return { ceremony: "Healing / Gratitude", desc: "Full Moon: Community healing, Upper World connection, milk offerings.", source: "Eurasian Shamanic Traditions" };
    if (moon.phaseIdx === 6) return { ceremony: "Banishing / Cord Cutting", desc: "Last Quarter: Releasing attachments, cleansing.", source: "Eurasian Shamanic Traditions" };
    return { ceremony: "General Practice Day", desc: "", source: "Eurasian Shamanic Traditions" };
}

function getQueroData(moon, date) {
    const key = `${date.getMonth()+1}-${date.getDate()}`;
    if (key === "8-1") return { name: "Pachamama Raymi (Earth Mother Feast)", type: "Offering / Despacho", source: "Andean / Quero Tradition" };
    if (moon.phaseIdx === 4) return { name: "Junta Quilla (Full Moon)", type: "Karpay (Transmission) / Ayni (Reciprocity)", source: "Andean / Quero Tradition" };
    if (moon.phaseIdx === 0) return { name: "Musuq Quilla (New Moon)", type: "Saminchakuy (Refining/Cleansing)", source: "Andean / Quero Tradition" };
    return { name: "General Cycle", type: "K'intu / Prayer", source: "Andean / Quero Tradition" };
}

function getRedPathData(moon, date, doy) {
    const isEquinox = (doy >= 79 && doy <= 81) || (doy >= 265 && doy <= 267);
    const isSolstice = (doy >= 171 && doy <= 173) || (doy >= 354 && doy <= 356);
    if (isSolstice || isEquinox) return { name: "Seasonal Change", type: "Pipe Ceremony / Sweatlodge", source: "Red Path / Plains Traditions" };
    if (moon.phaseIdx === 4) return { name: "Full Moon", type: "Winyan (Women's Circle) / Pipe Ceremony", source: "Red Path / Plains Traditions" };
    if (moon.phaseIdx === 0) return { name: "New Moon", type: "Inipi (Purification) / Stone People's Lodge", source: "Red Path / Plains Traditions" };
    return { name: "Daily Walk", type: "Prayer / Smudging", source: "Red Path / Plains Traditions" };
}

function getMultiYear(year) {
    const stems = ["Wood", "Wood", "Fire", "Fire", "Earth", "Earth", "Metal", "Metal", "Water", "Water"];
    const branches = ["Rat", "Ox", "Tiger", "Rabbit", "Dragon", "Snake", "Horse", "Goat", "Monkey", "Rooster", "Dog", "Pig"];
    const cDiff = (year - 1984) % 60; const cOffset = cDiff < 0 ? cDiff + 60 : cDiff;
    const tElems = ["Fire", "Earth", "Iron", "Water", "Wood"];
    const tAnimals = ["Rabbit", "Dragon", "Snake", "Horse", "Sheep", "Monkey", "Bird", "Dog", "Pig", "Mouse", "Ox", "Tiger"];
    const tDiff = (year - 1027) % 60; const tOffset = tDiff < 0 ? tDiff + 60 : tDiff;
    return { chinese: `${cOffset % 2 === 0 ? "Yang" : "Yin"} ${stems[cOffset % 10]} ${branches[cOffset % 12]}`, tibetan: `${tOffset % 2 === 0 ? "Male" : "Female"} ${tElems[Math.floor(tOffset/2) % 5]} ${tAnimals[tOffset % 12]}` };
}

function getEgyptian(doy) {
    let d = doy - 253; if (d <= 0) d += 365; const m = Math.ceil(d / 30);
    if (d <= 120) return `Akhet (Inundation), Month ${m}`; if (d <= 240) return `Peret (Emergence), Month ${m}`; return `Shemu (Harvest), Month ${m}`;
}

function getVeintena(doy) {
    if (doy <= 19) return VEINTENAS[0]; const idx = Math.floor((doy - 20) / 20) + 1;
    if (idx < VEINTENAS.length) return VEINTENAS[idx]; return VEINTENAS[VEINTENAS.length-1];
}

// UPDATED: Suitability Engine with All Traditions
function getDailySuitability(date, moon, bio) {
    const tibetanDay = Math.floor(moon.age) + 1;
    const doy = getDayOfYear(date);
    const tHair = TIBETAN_HAIR[tibetanDay] || { s: "Neutral", d: "Neutral period" };
    const festivals = getPaganSlavicEvents(date, doy);
    const hebridean = getHebrideanGuidance(moon);
    const scottishHerbs = getScottishHerbs(date, moon);
    
    // Calendrical Calculations
    const hebrew = getHebrewData(date, moon);
    const islamic = getIslamicData(date);
    const roman = getRomanData(date);
    const anglo = getAngloSaxonData(date);
    const vedic = getVedicData(moon);
    const meso = getMesoamericanData(moon);
    const african = getAfricanData(date);
    
    // Shamanic Calculations
    const andean = getAndeanLogic(date, moon, doy);
    const entheo = getEntheogenLogic(date, moon);
    const redpath = getRedPathData(moon, date, doy);
    
    const good = [];
    const bad = [];
    const ceremony = [];
    const fire = []; // Fire Ceremony days

    // Hair Logic
    const hair = { status: tHair.s, desc: tHair.d };

    // Pagan/Slavic Logic (Fire Detection)
    festivals.forEach(f => {
        // Tag-based filtering logic handled in createCell, pushing all for now
        f.good.forEach(g => good.push({ txt: g, src: f.trad, tag: f.tag }));
        f.bad.forEach(b => bad.push({ txt: b, src: f.trad, tag: f.tag }));
        ceremony.push(`${f.name}: ${f.ceremony} (${f.trad})`);
        
        // Fire Logic (Fixed Festivals)
        const isFire = f.type.toLowerCase().includes('fire') || f.ceremony.toLowerCase().includes('fire') || f.ceremony.toLowerCase().includes('bonfire') || f.name.includes("Yule") || f.name.includes("Litha");
        if (isFire) {
            fire.push({ name: f.name, trad: f.trad, note: f.ceremony });
            good.push({ txt: "Fire Ceremony / Bonfire", src: f.trad });
        }
    });
    
    // Andean Fire Logic (Fixed)
    if (andean.fixed && (andean.fixed.name.includes("Inti Raymi") || andean.fixed.name.includes("Pachamama"))) {
        fire.push({ name: andean.fixed.name, trad: "Andean / Quero", note: "Solar/Earth Fire Offerings" });
    }
    
    // NEW: General Lunar/Weekday Fire Logic (Waxing/Full + Weekend)
    // Waxing (1-4) or Full (4). Weekend = Fri(5), Sat(6), Sun(0).
    const isWaxingOrFull = moon.phaseIdx >= 1 && moon.phaseIdx <= 4;
    const isWeekend = date.getDay() === 0 || date.getDay() === 5 || date.getDay() === 6;

    if (isWaxingOrFull && isWeekend) {
        // Check duplication with fixed festivals to avoid double entry
        const alreadyHasFire = fire.some(f => f.trad.includes("Folk") || f.trad.includes("General"));
        if (!alreadyHasFire) {
            fire.push({
                name: "Weekend Fire Ritual",
                trad: "General Elemental / Folk",
                note: `Moon (${moon.phaseName}) supports growth & illumination. Weekend timing traditional for community.`
            });
            good.push({ txt: "Community Fire Circles", src: "General Ritual Timing" });
        }
    }

    // NEW: End of Year / Yule Log (Dec 20-31)
    if (date.getMonth() === 11 && date.getDate() >= 20) {
         // Avoid duplicating Yule fixed date
         const isYuleFixed = fire.some(f => f.name.includes("Yule") && f.trad.includes("Slavic"));
         if (!isYuleFixed) {
             fire.push({
                name: "Year-End Release / Yule",
                trad: "Celtic / Nordic / Generic",
                note: "Burning the Yule log, releasing the old year."
            });
            good.push({ txt: "Burning the Old Year", src: "End-of-Year Tradition" });
         }
    }
    
    // Hebridean Logic
    hebridean.good.forEach(g => good.push(g));
    hebridean.bad.forEach(b => bad.push(b));
    
    // Scottish Herbs Logic
    scottishHerbs.filter(h => h.suitable).forEach(h => {
        good.push({ txt: `Harvest ${h.name} (${h.part})`, src: "Scottish Folk Herbalism" });
    });
    
    // Andean Logic
    andean.good.forEach(g => good.push(g));
    andean.bad.forEach(b => bad.push(b));
    andean.ceremony.forEach(c => ceremony.push(c));
    
    // Entheogen Logic
    entheo.aya.good.forEach(g => good.push(g));
    entheo.aya.bad.forEach(b => bad.push(b));
    entheo.mush.good.forEach(g => good.push(g));
    entheo.mush.bad.forEach(b => bad.push(b));
    
    // Hebrew Logic
    hebrew.good.forEach(g => good.push(g));
    hebrew.bad.forEach(b => bad.push(b));
    if(hebrew.note.includes("Rosh Chodesh") || hebrew.note.includes("Shabbat")) ceremony.push(hebrew.note);
    
    // Vedic Logic
    vedic.good.forEach(g => good.push(g));
    vedic.bad.forEach(b => bad.push(b));
    if(vedic.tithi.includes("Amavasya") || vedic.tithi.includes("Purnima")) ceremony.push(`Vedic: ${vedic.tithi}`);

    // Mercury Retrograde Check
    const isRx = MERCURY_RETROGRADE.some(r => {
        const start = new Date(r.start); const end = new Date(r.end);
        return date >= start && date <= end;
    });

    if (isRx) {
        bad.push({ txt: "Signing contracts & Tech upgrades", src: "Astrological (Mercury Retrograde)" });
        bad.push({ txt: "Initiating long travel", src: "Astrological (Mercury Retrograde)" });
    }

    // Ceremony Focus (Existing)
    if (tibetanDay === 10 || tibetanDay === 25) ceremony.push("Vajrayana Feast Offering (Tsog) - Tibetan");
    if (moon.phaseIdx === 0) ceremony.push("Ancestor Offerings - Shamanic/Folk");
    if (moon.phaseIdx === 4) ceremony.push("Full Moon Celebration - Universal");
    if (tibetanDay === 8) ceremony.push("Medicine Buddha Practice - Tibetan");

    // Suitability - Western/Alchemical
    if (moon.phaseIdx === 0) bad.push({ txt: "Starting visible growth projects", src: "Western Alchemy (Dark Moon)" });
    if (moon.phaseIdx === 4) good.push({ txt: "Harvesting above-ground parts", src: "Western Herbalism" });
    if (moon.phaseIdx >= 1 && moon.phaseIdx <= 3) good.push({ txt: "Project initiation & Expansion", src: "Western Alchemy (Waxing)" });
    if (moon.phaseIdx >= 5 && moon.phaseIdx <= 7) good.push({ txt: "Banishment & Release", src: "Western Alchemy (Waning)" });

    // Suitability - Biodynamic
    if (bio.type === "Root" && moon.phaseIdx >= 4) good.push({ txt: "Root harvesting", src: "Biodynamic Agriculture (Waning + Earth)" });
    if (bio.type === "Leaf" && moon.phaseIdx <= 3) good.push({ txt: "Leaf harvesting", src: "Biodynamic Agriculture (Waxing + Water)" });

    // Suitability - Tibetan (Travel & Earth)
    if ([1, 2, 8, 15, 29, 30].includes(tibetanDay)) bad.push({ txt: "Long distance travel", src: "Tibetan Lunar Astrology" });
    if ([8, 15, 25, 29, 30].includes(tibetanDay) || moon.phaseIdx === 0) bad.push({ txt: "Earth disturbance / Foundation digging", src: "Tibetan & Shamanic (Naga/Spirit Days)" });

    // Multiplier Days
    if ([8, 15, 30].includes(tibetanDay)) good.push({ txt: "Accumulating Merit (Effects Multiplied)", src: "Tibetan Lunar System" });

    return { hair, good, bad, ceremony, festivals, hebridean, scottishHerbs, hebrew, islamic, roman, anglo, vedic, meso, african, andean, entheo, redpath, fire };
}

const SVGS = {
    moon: (idx, size="icon-md") => {
        const r = 42; let d = "";
        if (idx===4) d=`<circle cx="50" cy="50" r="${r}" fill="currentColor"/>`;
        else if (idx===2) d=`<path d="M50,8 A${r},${r} 0 0,1 50,92 Z" fill="currentColor"/>`;
        else if (idx===6) d=`<path d="M50,8 A${r},${r} 0 0,0 50,92 Z" fill="currentColor"/>`;
        else if (idx===1) d=`<path d="M50,8 A${r},${r} 0 0,1 50,92 A32,${r} 0 0,0 50,8 Z" fill="currentColor"/>`;
        else if (idx===7) d=`<path d="M50,8 A${r},${r} 0 0,0 50,92 A32,${r} 0 0,1 50,8 Z" fill="currentColor"/>`;
        else if (idx===3) d=`<path d="M50,8 A${r},${r} 0 0,1 50,92 A32,${r} 0 0,1 50,8 Z" fill="currentColor"/>`;
        else if (idx===5) d=`<path d="M50,8 A${r},${r} 0 0,0 50,92 A32,${r} 0 0,0 50,8 Z" fill="currentColor"/>`;
        return `<svg viewBox="0 0 100 100" class="${size} icon-shadow moon-anim"><circle cx="50" cy="50" r="46" fill="none" stroke="currentColor" stroke-width="4"/>${d}</svg>`;
    },
    element: (el, size="icon-sm") => {
        let d, c;
        switch(el) { case 'fire': d="M12,3 L22,21 L2,21 Z"; c="var(--color-fire)"; break; case 'earth': d="M2,4 L22,4 L12,22 Z M4,14 L20,14"; c="var(--color-earth)"; break; case 'air': d="M12,3 L22,21 L2,21 Z M4,11 L20,11"; c="var(--color-air)"; break; case 'water': d="M2,4 L22,4 L12,22 Z"; c="var(--color-water)"; break; }
        return `<svg viewBox="0 0 24 24" class="${size} icon-shadow anim-spin-glow"><path d="${d}" fill="${c}" fill-opacity="0.3" stroke="${c}" stroke-width="2.5" stroke-linejoin="round"/></svg>`;
    },
    plant: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow anim-pulse"><path d="M12 22v-8m0 0a5 5 0 0 1 5-5 5 5 0 0 0 5 5m-10 0a5 5 0 0 0-5-5 5 5 0 0 1-5 5" fill="none" stroke="var(--color-plant)" stroke-width="2.5" stroke-linecap="round"/></svg>`,
    leaf: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow anim-pulse"><path d="M12 2C8 2 4 8 4 14C4 18 8 22 12 22C16 22 20 18 20 14C20 8 16 2 12 2Z M12 22 L12 6" fill="none" stroke="var(--color-herb-leaf)" stroke-width="2.5" stroke-linecap="round"/></svg>`,
    flower: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow anim-float"><circle cx="12" cy="12" r="3" fill="none" stroke="var(--color-herb-flower)" stroke-width="2"/><path d="M12 9V5 M12 15V19 M9 12H5 M15 12H19 M14 10L17 7 M10 14L7 17 M10 10L7 7 M14 14L17 17" stroke="var(--color-herb-flower)" stroke-width="2" stroke-linecap="round"/></svg>`,
    fruit: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow anim-rock"><circle cx="12" cy="14" r="6" fill="none" stroke="var(--color-herb-fruit)" stroke-width="2.5"/><path d="M12 8V4 M10 6L14 6" stroke="var(--color-herb-fruit)" stroke-width="2" stroke-linecap="round"/></svg>`,
    root: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow anim-rock"><path d="M12 2V10 M12 10L8 16 M12 10L16 16 M12 10V22" stroke="var(--color-herb-root)" stroke-width="2.5" stroke-linecap="round"/><path d="M8 2L16 2" stroke="var(--color-herb-root)" stroke-width="2"/></svg>`,
    harvest: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow anim-rock"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9" fill="none" stroke="var(--color-harvest)" stroke-width="2.5"/></svg>`,
    sickle: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow anim-rock"><path d="M19 19C19 12 14 6 9 6C7 6 6 7 6 8C6 9 7 9 9 9C12 9 15 13 15 19" stroke="var(--color-celtic)" stroke-width="2.5" stroke-linecap="round" fill="none"/><path d="M19 19L21 21" stroke="var(--color-celtic)" stroke-width="2.5" stroke-linecap="round"/></svg>`,
    bottle: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow anim-pulse"><path d="M9,2 L15,2 L15,6 L20,10 L20,22 L4,22 L4,10 L9,6 Z" fill="none" stroke="var(--color-alchemy)" stroke-width="2.5" stroke-linejoin="round"/><path d="M9,2 L9,6 M15,2 L15,6" stroke="var(--color-alchemy)" stroke-width="2.5"/></svg>`,
    knot: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow anim-spin-glow"><path d="M12,2 L14,7 L20,7 L16,11 L18,17 L12,14 L6,17 L8,11 L4,7 L10,7 Z" fill="none" stroke="var(--color-celtic)" stroke-width="2.5" stroke-linejoin="round"/></svg>`,
    bowl: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow anim-float"><path d="M2 12h20M2 12c0 5.5 4.5 10 10 10s10-4.5 10-10" fill="none" stroke="var(--color-tcm)" stroke-width="2.5"/><path d="M12 7V3m-4 4V4m8 3V4" stroke="var(--color-tcm)" stroke-width="2.5" stroke-linecap="round"/></svg>`,
    drum: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow anim-pulse"><circle cx="12" cy="12" r="10" fill="none" stroke="var(--color-shaman)" stroke-width="2.5"/><path d="M12 12l5-5M12 12l-5-5M12 12l5 5M12 12l-5 5" stroke="var(--color-shaman)" stroke-width="2"/></svg>`,
    kintu: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow anim-float"><path d="M12 21 C12 21 20 16 20 10 C20 6 16 3 12 3 C8 3 4 6 4 10 C4 16 12 21 12 21 Z" fill="none" stroke="var(--color-quero)" stroke-width="2.5"/><path d="M12 3 L12 21" stroke="var(--color-quero)" stroke-width="1.5"/></svg>`,
    feather: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow anim-float"><path d="M20.2 3.8 C20.2 3.8 21 6 18 10 C15 14 6 22 2 22 C3 18 6 12 10 8 C14 4 18 3 20.2 3.8 Z M10 8 L13 11" fill="none" stroke="var(--color-redpath)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
    ankh: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow anim-spin-glow"><path d="M12 2C9.5 2 7.5 4 7.5 6.5C7.5 9 12 13 12 13C12 13 16.5 9 16.5 6.5C16.5 4 14.5 2 12 2Z M12 4.5A2 2 0 1 1 12 8.5A2 2 0 0 1 12 4.5Z M6 15L18 15 M12 13L12 22" fill="none" stroke="var(--color-egypt)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
    star: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow anim-float"><path d="M12 2L14.5 9L22 9L16 14L18.5 21L12 17L5.5 21L8 14L2 9L9.5 9L12 2Z" fill="none" stroke="var(--color-marian)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
    lotus: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow anim-pulse"><path d="M12 21C12 21 6 16 6 10C6 6 9 3 12 3C15 3 18 6 18 10C18 16 12 21 12 21Z M12 21L12 15 M9 15C9 15 5 12 5 8 M15 15C15 15 19 12 19 8" fill="none" stroke="var(--color-buddhist)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
    
    // NEW ICONS
    scissors: (size="icon-sm", color="currentColor") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow anim-rock"><path d="M6 6L18 18M6 18L18 6" stroke="${color}" stroke-width="2"/><circle cx="6" cy="6" r="3" fill="none" stroke="${color}" stroke-width="2"/><circle cx="6" cy="18" r="3" fill="none" stroke="${color}" stroke-width="2"/></svg>`,
    foot: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow"><path d="M14 2c2 0 3 3 3 5 0 2.5-1.5 4-3 6-1 1.5-3 3-4 5-1 1-2 2-3 2s-1-1-1-2c0-1 0-3 1-5 1-2 3-5 3-7s1-4 4-4z" fill="none" stroke="var(--color-neutral)" stroke-width="2"/></svg>`,
    spark: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow anim-pulse"><path d="M12 2L14 10L22 12L14 14L12 22L10 14L2 12L10 10Z" fill="var(--color-good)" stroke="none"/></svg>`,
    hand: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow"><path d="M12 2L12 22M2 12L22 12" stroke="var(--color-bad)" stroke-width="3"/></svg>`,
    
    // PAGAN/SLAVIC ICONS
    skull: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow anim-float"><path d="M12 2c-4 0-8 3-8 8 0 4 3 6 4 7 0 2-1 3-2 3 0 0 2 2 6 2s6-2 6-2c-1 0-2-1-2-3 1-1 4-3 4-7 0-5-4-8-8-8zM8 11c-1 0-2-1-2-2s1-2 2-2 2 1 2 2-1 2-2 2zm8 0c-1 0-2-1-2-2s1-2 2-2 2 1 2 2-1 2-2 2z" fill="none" stroke="var(--text-muted)" stroke-width="2"/></svg>`,
    fire: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow anim-pulse"><path d="M12 2c0 0-6 7-6 12 0 5 4 8 6 8s6-3 6-8c0-5-6-12-6-12z" fill="var(--color-fire)" fill-opacity="0.2" stroke="var(--color-fire)" stroke-width="2"/><path d="M12 14c0 0-2 2-2 4s2 2 2 2 2-1 2-4-2-2-2-2z" fill="var(--color-fire)"/></svg>`,
    sheaf: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow anim-rock"><path d="M6 22L12 12L18 22M12 2L12 12M6 2L12 12M18 2L12 12M5 16h14" stroke="var(--color-earth)" stroke-width="2" stroke-linecap="round"/></svg>`,
    spiral: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow anim-spin-glow"><path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" stroke="var(--color-good)" fill="none" stroke-width="0.5"/><path d="M12 12c0 0 0-3 3-3s3 3 0 6s-6 0-6-6s6-9 12-9" stroke="var(--color-good)" fill="none" stroke-width="2" stroke-linecap="round"/></svg>`,
    
    // HEBRIDEAN/SCOTTISH ICONS
    fish: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow anim-float"><path d="M17 10c-2-2-5-2-7 0l-5 5c-1 1-1 2 0 3s2 1 3 0l5-5c2-2 2-5 0-7z" fill="none" stroke="var(--color-scottish)" stroke-width="2"/><circle cx="15" cy="9" r="1" fill="var(--color-scottish)"/></svg>`,
    spade: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow anim-rock"><path d="M9 14l-2 8M15 14l2 8M12 14v-6M9 4l6 0M12 4v4M12 14l-3-4c0-2 1-3 3-3s3 1 3 3l-3 4" fill="none" stroke="var(--color-earth)" stroke-width="2" stroke-linecap="round"/></svg>`,
    basket: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow"><path d="M4 10l2 10h12l2-10H4zM8 10V6a4 4 0 0 1 8 0v4" fill="none" stroke="var(--color-scottish)" stroke-width="2" stroke-linejoin="round"/></svg>`,
    
    // NEW TRADITION ICONS
    menorah: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow"><path d="M2 12h20M12 12v8M12 20h-4M12 20h4M4 12v-2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v2M8 12v-2a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M12 2v10" stroke="var(--color-hebrew)" fill="none" stroke-width="2" stroke-linecap="round"/></svg>`,
    om: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow"><path d="M12 2c5 0 9 4 9 9s-4 9-9 9-9-4-9-9 4-9 9-9zM12 7c2 0 3 1 3 3s-1 3-3 3c-2 0-3 1-3 3" stroke="var(--color-vedic)" fill="none" stroke-width="2"/><circle cx="12" cy="18" r="1" fill="var(--color-vedic)"/></svg>`,
    glyph: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow"><rect x="4" y="4" width="16" height="16" rx="2" stroke="var(--color-meso)" fill="none" stroke-width="2"/><path d="M8 8h8M8 12h8M8 16h4" stroke="var(--color-meso)" stroke-width="2"/></svg>`,
    mask: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow"><path d="M5 4h14l-1 14a6 6 0 0 1-6 6 6 6 0 0 1-6-6zM9 10h1M14 10h1M12 16h0" stroke="var(--color-african)" fill="none" stroke-width="2" stroke-linecap="round"/></svg>`,
    wheat: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow"><path d="M12 2v20M8 6c2 2 2 6 0 8M16 6c-2 2-2 6 0 8" stroke="var(--color-balkan)" fill="none" stroke-width="2" stroke-linecap="round"/></svg>`,
    
    // SHAMANIC ICONS
    chakana: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow"><path d="M10 2h4v4h4v4h4v4h-4v4h-4v4h-4v-4h-4v-4h-4v-4h4v-4h4v-4z" fill="none" stroke="var(--color-andean)" stroke-width="2"/></svg>`,
    vine: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow anim-spin-glow"><path d="M12 2C6 2 2 6 2 12s4 10 10 10 10-4 10-10S18 2 12 2zm0 18c-4.4 0-8-3.6-8-8s3.6-8 8-8 8 3.6 8 8-3.6 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z" fill="none" stroke="var(--color-amazon)" stroke-width="2" stroke-dasharray="2 2"/></svg>`,
    mushroom: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow anim-float"><path d="M12 4c-5 0-9 3-9 7 0 2 3 3 3 5v4h12v-4c0-2 3-3 3-5 0-4-4-7-9-7z" fill="none" stroke="var(--color-mushroom)" stroke-width="2"/><path d="M9 16v4M15 16v4M8 11a4 4 0 0 1 8 0" stroke="var(--color-mushroom)" stroke-width="1.5"/></svg>`,
    cactus: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow anim-rock"><path d="M12 2a2 2 0 0 1 2 2v16a2 2 0 0 1-4 0V4a2 2 0 0 1 2-2z M6 8a2 2 0 0 1 2 2v6a2 2 0 0 0 4 0 M18 8a2 2 0 0 0-2 2v6a2 2 0 0 1-4 0" fill="none" stroke="var(--color-andean)" stroke-width="2" stroke-linecap="round"/></svg>`,
    cup: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow anim-pulse"><path d="M19 8C19 11.866 15.866 15 12 15C8.13401 15 5 11.866 5 8C5 4.13401 12 2 12 2C12 2 19 4.13401 19 8Z" fill="none" stroke="var(--color-amazon)" stroke-width="2"/><path d="M12 15V22M8 22H16" stroke="var(--color-amazon)" stroke-width="2"/></svg>`,
    lodge: (size="icon-sm") => `<svg viewBox="0 0 24 24" class="${size} icon-shadow anim-pulse"><path d="M2 20h20M12 4c-5 0-9 6-9 16h18c0-10-4-16-9-16zM12 14l-2 4h4z" fill="none" stroke="var(--color-redpath)" stroke-width="2"/><path d="M12 13v-3M10 11l-2-2M14 11l2-2" stroke="var(--color-redpath)" stroke-width="1.5"/></svg>`
};

const TRADITION_KEYS = [
    'showAndean', 'showAmazon', 'showMushroom', 'showRedPath', 
    'showTibetan', 'showCeltic', 'showSlavic', 'showBalkan', 'showScottish',
    'showHebrew', 'showIslamic', 'showVedic', 
    'showMeso', 'showAfrican', 'showRoman', 'showAnglo', 'showEco'
];
const TYPE_KEYS = [
    'showCeremonial', 'showHair', 'showFavorable', 'showUnfavorable', 'showFire'
];

const App = {
    date: new Date(),
    selectedDate: new Date(),
    filters: {
        showAndean: true, showAmazon: true, showMushroom: true,
        showRedPath: true, showTibetan: true, 
        showCeltic: true, showSlavic: true, showBalkan: true, showScottish: true,
        showHebrew: true, showIslamic: true, showVedic: true, 
        showMeso: true, showAfrican: true, showRoman: true, showAnglo: true,
        showEco: true,
        showCeremonial: true, showHair: true, showFavorable: true, showUnfavorable: true, showFire: true
    },
    
    init() {
        this.generateThemes(); this.loadState(); this.renderSettings(); this.render(); this.setupListeners(); this.initTooltips(); this.initClock();
    },

    initClock() {
        const clockEl = document.getElementById('live-clock');
        const update = () => {
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
            clockEl.textContent = `${dateStr} • ${timeStr}`;
        };
        update();
        setInterval(update, 1000);
    },

    initTooltips() {
        const tooltip = document.getElementById('global-tooltip');
        const updatePos = (e) => {
            const pad = 12; let x = e.clientX + pad; let y = e.clientY + pad;
            const rect = tooltip.getBoundingClientRect();
            // Prevent overflowing right/bottom
            if (x + rect.width > window.innerWidth) x = window.innerWidth - rect.width - pad;
            if (y + rect.height > window.innerHeight) y = window.innerHeight - rect.height - pad;
            // Prevent overflowing left/top
            if (x < 0) x = pad;
            if (y < 0) y = pad;
            
            tooltip.style.left = x + 'px'; tooltip.style.top = y + 'px';
        };
        document.body.addEventListener('mouseover', (e) => { 
            const target = e.target.closest('[data-tooltip]'); 
            if (target) { 
                tooltip.textContent = target.getAttribute('data-tooltip'); 
                tooltip.style.opacity = '1'; 
                updatePos(e); 
            } 
        });
        document.body.addEventListener('mouseout', (e) => { 
            const target = e.target.closest('[data-tooltip]'); 
            if (target) { tooltip.style.opacity = '0'; } 
        });
        document.body.addEventListener('mousemove', (e) => { 
            if (tooltip.style.opacity === '1') { updatePos(e); } 
        });
    },

    generateThemes() {
        const sel = document.getElementById('theme-selector');
        for(let i=0; i<50; i++) { const opt = document.createElement('option'); opt.value = i; opt.textContent = `Theme ${i+1}`; sel.appendChild(opt); }
    },

    loadState() {
        const t = Storage.get('arc_theme') || 0; document.getElementById('theme-selector').value = t; this.applyTheme(t);
        const logoData = Storage.get('arc_logo'); const logoPos = Storage.get('arc_logo_pos') || 'logo-top-center';
        const img = document.getElementById('user-logo');
        if (logoData) img.src = logoData; else img.src = DEFAULT_LOGO;
        img.className = logoPos; img.style.display = 'block';
        const savedFilters = Storage.get('arc_filters');
        if (savedFilters) { try { this.filters = { ...this.filters, ...JSON.parse(savedFilters) }; } catch(e) {} }
    },

    applyTheme(idx) {
        const hue = (idx * 137.5) % 360; const root = document.documentElement.style; const isDark = idx % 2 === 0; const sat = 10;
        root.setProperty('--bg-color', `hsl(${hue}, ${sat}%, ${isDark?8:96}%)`);
        root.setProperty('--surface-color', `hsl(${hue}, ${sat+5}%, ${isDark?15:90}%)`);
        root.setProperty('--text-main', `hsl(${hue}, 10%, ${isDark?90:15}%)`);
        root.setProperty('--border-color', `hsl(${hue}, 10%, ${isDark?25:80}%)`);
        root.setProperty('--accent-color', `hsl(${hue}, 40%, ${isDark?60:40}%)`);
        Storage.set('arc_theme', idx);
    },

    renderSettings() {
        const tDiv = document.getElementById('settings-traditions');
        const dDiv = document.getElementById('settings-types');
        tDiv.innerHTML = ''; dDiv.innerHTML = '';
        
        const createToggle = (key, label, parent, groupKeys) => {
            const div = document.createElement('div'); div.className = 'toggle-row';
            let btnHtml = ''; if (groupKeys) btnHtml = `<button class="btn-solo" data-key="${key}" title="Solo View (Reversible)">Solo</button>`;
            div.innerHTML = `<div class="toggle-wrapper"><span class="toggle-label">${label}</span>${btnHtml}</div><label><input type="checkbox" class="toggle-input" ${this.filters[key]?'checked':''}><div class="toggle-switch"></div></label>`;
            div.querySelector('input').onchange = (e) => { this.filters[key] = e.target.checked; Storage.set('arc_filters', JSON.stringify(this.filters)); this.render(); };
            if (groupKeys) {
                div.querySelector('.btn-solo').onclick = () => {
                    const isSolo = groupKeys.every(k => k === key ? this.filters[k] : !this.filters[k]);
                    if (isSolo) groupKeys.forEach(k => this.filters[k] = true); else groupKeys.forEach(k => this.filters[k] = (k === key));
                    Storage.set('arc_filters', JSON.stringify(this.filters)); this.renderSettings(); this.render();
                };
            }
            parent.appendChild(div);
        };
        
        createToggle('showAndean', 'Quechua / Andean Shamanism', tDiv, TRADITION_KEYS);
        createToggle('showAmazon', 'Amazonian (Ayahuasca/Shipibo)', tDiv, TRADITION_KEYS);
        createToggle('showMushroom', 'Mushroom Traditions (Global)', tDiv, TRADITION_KEYS);
        createToggle('showRedPath', 'Red Path / Native American', tDiv, TRADITION_KEYS); 
        createToggle('showTibetan', 'Tibetan Lunar', tDiv, TRADITION_KEYS);
        createToggle('showCeltic', 'Celtic / Nature Cycle', tDiv, TRADITION_KEYS);
        createToggle('showSlavic', 'Old Slavic', tDiv, TRADITION_KEYS);
        createToggle('showScottish', 'Scottish / Highland', tDiv, TRADITION_KEYS);
        createToggle('showBalkan', 'Balkan Folk', tDiv, TRADITION_KEYS);
        createToggle('showEco', 'Ecological / Biodynamic', tDiv, TRADITION_KEYS);
        createToggle('showHebrew', 'Hebrew Calendar', tDiv, TRADITION_KEYS);
        createToggle('showIslamic', 'Islamic Lunar', tDiv, TRADITION_KEYS);
        createToggle('showVedic', 'Vedic / Panchang', tDiv, TRADITION_KEYS);
        createToggle('showMeso', 'Mesoamerican', tDiv, TRADITION_KEYS);
        createToggle('showAfrican', 'African Traditional', tDiv, TRADITION_KEYS);
        createToggle('showRoman', 'Roman Calendar', tDiv, TRADITION_KEYS);
        createToggle('showAnglo', 'Anglo-Saxon Calendar', tDiv, TRADITION_KEYS);
        
        createToggle('showCeremonial', 'Ceremonial / Plant Medicine', dDiv, TYPE_KEYS);
        createToggle('showHair', 'Hair Cutting (Tibetan)', dDiv, TYPE_KEYS);
        createToggle('showFavorable', 'Favorable Days (Work/Harvest)', dDiv, TYPE_KEYS);
        createToggle('showUnfavorable', 'Unfavorable Days', dDiv, TYPE_KEYS);
        createToggle('showFire', 'Fire Ceremonies (Celtic/Slavic/Andean)', dDiv, TYPE_KEYS);
    },

    generateSummaryData() {
        const y = this.date.getFullYear(), m = this.date.getMonth();
        const days = new Date(y, m+1, 0).getDate();
        let events = [];

        for(let d=1; d<=days; d++) {
            const date = new Date(y, m, d);
            const moon = getMoonData(date);
            const bio = getBiodynamic(moon.signIdx);
            const works = getDailySuitability(date, moon, bio);
            const doy = getDayOfYear(date);
            const tibetanDay = Math.floor(moon.age) + 1;

            // Phase Events
            if (moon.phaseIdx === 0) events.push({ date, type: "Moon Phase", name: "New Moon", note: `Introspection, New Beginnings.`, tag: "astro" });
            if (moon.phaseIdx === 4) events.push({ date, type: "Moon Phase", name: "Full Moon", note: `Peak Energy, Illumination.`, tag: "astro" });

            // Plant Medicine Events (Respecting Filters)
            if (this.filters.showMushroom && works.entheo.mush.note) {
                events.push({ date, type: "Ceremonial", name: "Mushroom Ceremony", note: works.entheo.mush.note, tag: "shamanic" });
            }
            if (this.filters.showAmazon && works.entheo.aya.note) {
                events.push({ date, type: "Ceremonial", name: "Ayahuasca Ceremony", note: works.entheo.aya.note, tag: "shamanic" });
            }
            if (this.filters.showAndean && works.andean.fixed) {
                events.push({ date, type: "Ceremonial", name: works.andean.fixed.name, note: works.andean.fixed.ceremony, tag: "shamanic" });
            } else if (this.filters.showAndean && moon.phaseIdx === 4) {
                events.push({ date, type: "Ceremonial", name: "Junta Quilla (San Pedro)", note: "Full Moon Offering.", tag: "shamanic" });
            }
            if (this.filters.showRedPath && (works.redpath.type.includes("Sweatlodge") || works.redpath.type.includes("Lodge"))) {
                events.push({ date, type: "Ceremonial", name: works.redpath.name, note: works.redpath.type, tag: "shamanic" });
            }
            
            // Fire Ceremonies (Respecting Filters)
            if (this.filters.showFire && works.fire.length > 0) {
                works.fire.forEach(f => {
                    events.push({ date, type: "Fire Ceremony", name: f.name, note: `${f.trad}. ${f.note}`, tag: "shamanic" });
                });
            }

            // Festivals & Fixed (Respecting Filters)
            if (works.festivals.length > 0) {
                works.festivals.forEach(f => {
                    let show = false;
                    if(f.tag === 'celtic' && this.filters.showCeltic) show = true;
                    if(f.tag === 'slavic' && this.filters.showSlavic) show = true;
                    if(f.tag === 'balkan' && this.filters.showBalkan) show = true;
                    if (show) events.push({ date, type: "Festival", name: f.name, note: f.trad, tag: "festival" });
                });
            }

            // Tibetan Days
            if (this.filters.showTibetan && [8, 10, 15, 25, 30].includes(tibetanDay)) {
                let note = "Practice Day";
                if(tibetanDay===10) note = "Guru Rinpoche Day";
                if(tibetanDay===25) note = "Dakini Day";
                events.push({ date, type: "Tibetan", name: `Lunar Day ${tibetanDay}`, note: note, tag: "tibetan" });
            }
            
            // Astrological
            const isRx = MERCURY_RETROGRADE.some(r => {
                const start = new Date(r.start); const end = new Date(r.end);
                return date.getTime() === start.getTime() || date.getTime() === end.getTime();
            });
            if (isRx) events.push({ date, type: "Astrology", name: "Mercury Retrograde Station", note: "Change of direction.", tag: "astro" });
        }
        return events;
    },

    render() {
        const doy = getDayOfYear(this.date); const moon = getMoonData(this.date); const tradName = WESTERN_NAMES[this.date.getMonth()]; const weekday = getWeekdayData(this.date);
        document.getElementById('header-moon-icon').innerHTML = SVGS.moon(moon.phaseIdx, 'icon-xl');
        document.getElementById('header-date').textContent = this.date.toLocaleString('default', { month: 'long', year: 'numeric' });
        document.getElementById('header-doy').textContent = `Day ${doy} • ${moon.phaseName}`;
        document.getElementById('header-trad-name').textContent = tradName;
        document.getElementById('date-picker').value = this.date.toISOString().substr(0,10);
        const grid = document.getElementById('calendar-grid'); grid.innerHTML = '';
        const y = this.date.getFullYear(), m = this.date.getMonth(); const first = new Date(y, m, 1).getDay(); const days = new Date(y, m+1, 0).getDate();
        const notes = JSON.parse(Storage.get('arc_notes') || '{}'); const todayKey = new Date().toISOString().split('T')[0];
        for(let i=0; i<first; i++) grid.appendChild(this.createCell(null));
        for(let d=1; d<=days; d++) { const dt = new Date(y, m, d); const key = dt.toISOString().split('T')[0]; const cell = this.createCell(dt, key, notes[key], key === todayKey); grid.appendChild(cell); }
    },

    createCell(date, key, hasNote, isToday) {
        const el = document.createElement('div'); el.className = 'day-cell'; if (!date) { el.style.opacity = '0.3'; return el; }
        if (isToday) el.classList.add('today');
        const doy = getDayOfYear(date); const moon = getMoonData(date); const bio = getBiodynamic(moon.signIdx);
        const works = getDailySuitability(date, moon, bio);
        const wd = getWeekdayData(date); const celtic = getCelticData(date, doy); const tcm = getChineseGuidance(moon); const shaman = getShamanicData(moon); const celticHerbal = getCelticHerbalData(date, moon); const ukHerbs = getUKForaging(date); const deities = getDeityEvents(date, moon);
        
        // Plant Medicine Logic (Strict)
        let isPlantMedicineDay = false;
        // Determine if it is a San Pedro, Ayahuasca or Mushroom day specifically
        const isMushroomDay = works.entheo.mush.note && this.filters.showMushroom;
        const isAyahuascaDay = works.entheo.aya.note && this.filters.showAmazon;
        const isSanPedroDay = (works.andean.fixed || moon.phaseIdx === 4) && this.filters.showAndean;
        
        if (isMushroomDay || isAyahuascaDay || isSanPedroDay) {
            isPlantMedicineDay = true;
        }
        
        if (isPlantMedicineDay) el.classList.add('plant-medicine');

        // --- HEADER ---
        const h = document.createElement('div'); h.className = 'day-header';
        const wdIcon = `<div class="weekday-indicator" data-tooltip="${wd.day} (${wd.planet}): ${wd.element.toUpperCase()}">${SVGS.element(wd.element, 'icon-sm')}</div>`;
        h.innerHTML = `<div style="display:flex; gap:6px; align-items:center;"><span class="day-number">${date.getDate()}</span>${wdIcon}</div><div class="note-dot ${hasNote?'has-note':''}"></div>`;
        
        // --- CENTER ---
        const c = document.createElement('div'); c.className = 'day-center';
        const moonTooltip = `${moon.phaseName} in ${moon.sign}. Illumination: ${moon.illum}%.`;
        c.innerHTML = `<div data-tooltip="${moonTooltip}">${SVGS.moon(moon.phaseIdx, 'icon-lg')}</div>`;

        // --- CORNER ICONS (Plant Medicine & Ceremonial) ---
        const corner = document.createElement('div'); corner.className = 'corner-icons';
        if (this.filters.showCeremonial) {
            
            // STRICT MUSHROOM ICON ASSIGNMENT
            // If day is San Pedro OR Ayahuasca OR Mushroom -> Add Mushroom Icon top-right
            if (isPlantMedicineDay) {
                // Add the unifying Mushroom Icon if it's strictly a Mushroom day
                if (isMushroomDay) {
                     corner.innerHTML += `<div class="corner-icon" data-tooltip="Mushroom Ceremony: ${works.entheo.mush.note}">${SVGS.mushroom('icon-sm')}</div>`;
                }
            }

            // ADD EXISTING SPECIFIC ICONS (To be distinct and additive)
            // Ayahuasca (Vine/Cup)
            if (isAyahuascaDay) {
                corner.innerHTML += `<div class="corner-icon" data-tooltip="Ayahuasca: ${works.entheo.aya.note}">${SVGS.cup('icon-sm')}</div>`;
            }
            // San Pedro (Cactus)
            if (isSanPedroDay) {
                const tip = works.andean.fixed ? works.andean.fixed.name : "Junta Quilla (Full Moon)";
                corner.innerHTML += `<div class="corner-icon" data-tooltip="San Pedro / Andean: ${tip}">${SVGS.cactus('icon-sm')}</div>`;
            }
            
            // Red Path (Sweat Lodge) - distinct from above
            if (this.filters.showRedPath) {
                const isLodge = works.redpath.type.includes("Sweatlodge") || works.redpath.type.includes("Lodge");
                if (isLodge) {
                    corner.innerHTML += `<div class="corner-icon" data-tooltip="Red Path / Lodge: ${works.redpath.name}">${SVGS.lodge('icon-sm')}</div>`;
                }
            }
        }
        
        // FIRE ICONS (Distinct and filterable)
        if (this.filters.showFire && works.fire.length > 0) {
            works.fire.forEach(f => {
                corner.innerHTML += `<div class="corner-icon" data-tooltip="Fire Ceremony (${f.trad}). Type: ${f.name}. Advisory: ${f.note}. Source: Traditional/General.">${SVGS.fire('icon-sm')}</div>`;
            });
        }
        
        // --- FOOTER ---
        const f = document.createElement('div'); f.className = 'day-footer';
        const eIcon = document.createElement('div'); eIcon.innerHTML = SVGS.element(bio.element, 'icon-md'); eIcon.setAttribute('data-tooltip', `Moon in ${moon.sign}: ${bio.element.toUpperCase()} (${bio.type})`);
        const dots = document.createElement('div'); dots.className = 'icon-row';
        
        // Hair Icon (Tibetan)
        if (this.filters.showHair && this.filters.showTibetan) {
            let hairColor = "var(--color-neutral)";
            if (works.hair.status === "Favorable") hairColor = "var(--color-good)";
            if (works.hair.status === "Unfavorable") hairColor = "var(--color-bad)";
            dots.innerHTML += `<div data-tooltip="Tibetan Hair Cutting: ${works.hair.status}. ${works.hair.desc}">${SVGS.scissors('icon-sm', hairColor)}</div>`;
        }

        // Deities & Euro Folk
        if (deities.length > 0) deities.forEach(d => dots.innerHTML += `<div data-tooltip="${d.name} (${d.deity})">${SVGS[d.icon]('icon-sm')}</div>`);
        
        // Granular Euro Traditions
        if (works.festivals && works.festivals.length > 0) {
            works.festivals.forEach(fest => {
                let show = false;
                if(fest.tag === 'celtic' && this.filters.showCeltic) show = true;
                if(fest.tag === 'slavic' && this.filters.showSlavic) show = true;
                if(fest.tag === 'balkan' && this.filters.showBalkan) show = true;
                if(show) dots.innerHTML += `<div data-tooltip="${fest.name} (${fest.trad})">${SVGS[fest.icon]('icon-sm')}</div>`;
            });
        }
        
        if (celticHerbal.plant && this.filters.showCeltic) dots.innerHTML += `<div data-tooltip="Celtic Herbal: ${celticHerbal.plant}">${SVGS.sickle('icon-sm')}</div>`;
        if (celtic.isFestival && this.filters.showCeltic) dots.innerHTML += `<div data-tooltip="${celtic.festival}">${SVGS.knot('icon-sm')}</div>`;
        
        // Harvest / Herbs (Visible if Favorable)
        if (this.filters.showFavorable && this.filters.showEco) {
            if (ukHerbs.types.includes("Leaf")) dots.innerHTML += `<div data-tooltip="Leaf Harvest">${SVGS.leaf('icon-sm')}</div>`;
            if (ukHerbs.types.includes("Flower")) dots.innerHTML += `<div data-tooltip="Flower Harvest">${SVGS.flower('icon-sm')}</div>`;
            if (ukHerbs.types.includes("Fruit")) dots.innerHTML += `<div data-tooltip="Fruit Harvest">${SVGS.fruit('icon-sm')}</div>`;
            if (ukHerbs.types.includes("Root")) dots.innerHTML += `<div data-tooltip="Root Harvest">${SVGS.root('icon-sm')}</div>`;
            if (works.scottishHerbs.some(h => h.suitable) && this.filters.showScottish) dots.innerHTML += `<div data-tooltip="Scottish Herbs Available">${SVGS.basket('icon-sm')}</div>`;
        }
        
        if (this.filters.showScottish) {
             if (works.hebridean.fish.status === "Good") dots.innerHTML += `<div data-tooltip="Fishing: ${works.hebridean.fish.status}">${SVGS.fish('icon-sm')}</div>`;
             if (works.hebridean.croft.status === "Sowing") dots.innerHTML += `<div data-tooltip="Crofting: Sowing">${SVGS.spade('icon-sm')}</div>`;
        }
        
        if (this.filters.showFavorable) {
            if (works.good.some(w => w.txt.includes("Harvesting"))) dots.innerHTML += `<div data-tooltip="Harvest Suitable">${SVGS.harvest('icon-sm')}</div>`;
            if (works.good.some(w => w.txt.includes("initiation"))) dots.innerHTML += `<div data-tooltip="Project Initiation">${SVGS.spark('icon-sm')}</div>`;
        }
        
        // Global Calendars
        if (this.filters.showHebrew && works.hebrew.note) dots.innerHTML += `<div data-tooltip="${works.hebrew.note}">${SVGS.menorah('icon-sm')}</div>`;
        if (this.filters.showVedic && (works.vedic.tithi.includes("Amavasya") || works.vedic.tithi.includes("Purnima"))) dots.innerHTML += `<div data-tooltip="${works.vedic.tithi}">${SVGS.om('icon-sm')}</div>`;
        if (this.filters.showMeso && works.meso.note) dots.innerHTML += `<div data-tooltip="${works.meso.long}: ${works.meso.note}">${SVGS.glyph('icon-sm')}</div>`;
        if (this.filters.showAfrican && works.african.cycle.includes("Day 1")) dots.innerHTML += `<div data-tooltip="${works.african.cycle}">${SVGS.mask('icon-sm')}</div>`;
        
        // Shamanic Footer Icons (General)
        if (this.filters.showAndean && works.andean.fixed) dots.innerHTML += `<div data-tooltip="${works.andean.fixed.name}">${SVGS.chakana('icon-sm')}</div>`;
        if (this.filters.showCeremonial && shaman.ceremony !== "General Practice Day") dots.innerHTML += `<div data-tooltip="Ceremony: ${shaman.ceremony}">${SVGS.drum('icon-sm')}</div>`;
        
        // Unfavorable
        if (this.filters.showUnfavorable && works.bad.some(w => w.txt.includes("travel"))) dots.innerHTML += `<div data-tooltip="Travel Caution">${SVGS.hand('icon-sm')}</div>`;

        f.appendChild(eIcon); f.appendChild(dots); el.append(h, c, corner, f);
        el.onclick = () => this.openDetail(date);
        return el;
    },

    openDetail(date) {
        this.selectedDate = date; const key = date.toISOString().split('T')[0]; const doy = getDayOfYear(date); const moon = getMoonData(date); const bio = getBiodynamic(moon.signIdx); const multi = getMultiYear(date.getFullYear());
        const works = getDailySuitability(date, moon, bio);
        const wd = getWeekdayData(date); const notes = JSON.parse(Storage.get('arc_notes') || '{}'); const celtic = getCelticData(date, doy); const celticHerbal = getCelticHerbalData(date, moon); const tcm = getChineseGuidance(moon); const shaman = getShamanicData(moon); const quero = getQueroData(moon, date); const redpath = getRedPathData(moon, date, doy); const ukHerbs = getUKForaging(date); const deities = getDeityEvents(date, moon);
        
        document.getElementById('detail-date').textContent = date.toDateString();
        document.getElementById('detail-weekday-icon').innerHTML = SVGS.element(wd.element, 'icon-sm');
        document.getElementById('detail-weekday').textContent = `${wd.day} • ${wd.planet} Rule • ${wd.element.toUpperCase()} Element`;
        document.getElementById('detail-phase').textContent = `${moon.phaseName} in ${moon.sign}`;
        document.getElementById('detail-age').textContent = moon.age.toFixed(1) + 'd';
        document.getElementById('detail-illum').textContent = moon.illum + '%';
        document.getElementById('detail-sign').textContent = moon.sign;
        document.getElementById('detail-western').textContent = WESTERN_NAMES[date.getMonth()];
        document.getElementById('detail-meso').textContent = getVeintena(doy);
        document.getElementById('detail-egypt').textContent = getEgyptian(doy);
        document.getElementById('detail-chinese').textContent = multi.chinese;
        document.getElementById('detail-tibetan').textContent = multi.tibetan;
        
        // Hair Cutting Section
        const hCon = document.getElementById('detail-hair-container');
        if (this.filters.showHair) {
            let hClass = "status-neutral"; if(works.hair.status==="Favorable") hClass="status-good"; if(works.hair.status==="Unfavorable") hClass="status-bad";
            hCon.innerHTML = `
                <div class="hair-box">
                    ${SVGS.scissors('icon-md', `var(--color-${works.hair.status==="Favorable"?'good':works.hair.status==="Unfavorable"?'bad':'neutral'})`)}
                    <div>
                        <div style="font-size:0.75rem; text-transform:uppercase; color:var(--text-muted)">Tibetan Hair Cutting</div>
                        <div class="hair-status ${hClass}">${works.hair.status}</div>
                        <div style="font-size:0.85rem; font-style:italic;">"${works.hair.desc}"</div>
                    </div>
                </div>
            `;
        } else { hCon.innerHTML = ''; }
        
        // Hebridean Lore Display
        const hebCon = document.getElementById('detail-hebridean');
        let fClass = works.hebridean.fish.status === "Good" ? "status-good" : (works.hebridean.fish.status === "Avoid" ? "status-bad" : "status-neutral");
        hebCon.innerHTML = `
            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                <div>
                    <span class="data-label">Fishing Lore</span><br>
                    <span class="${fClass}" style="font-weight:bold;">${works.hebridean.fish.status}</span>
                </div>
                <div style="text-align:right;">
                    <span class="data-label">Crofting</span><br>
                    <span style="font-weight:bold; color:var(--color-scottish);">${works.hebridean.croft.status}</span>
                </div>
            </div>
            <div style="font-size:0.9rem; margin-top:4px;">
                "${works.hebridean.fish.desc}"
            </div>
             <div style="font-size:0.9rem; margin-top:4px;">
                "${works.hebridean.croft.desc}"
            </div>
        `;
        
        // World Calendars Display
        const wcDiv = document.getElementById('detail-world-cals'); wcDiv.innerHTML = '';
        const addCalItem = (label, val, note, tagClass) => {
            const d = document.createElement('div'); d.className = 'work-item';
            d.innerHTML = `<span class="work-tag ${tagClass}">${label}</span><div style="font-size:0.9rem"><strong>${val}</strong><br><span style="color:var(--text-muted);font-size:0.8rem">${note}</span></div>`;
            wcDiv.appendChild(d);
        };
        if(this.filters.showHebrew) addCalItem("Hebrew", works.hebrew.date, works.hebrew.note || "General Calendrical Period", "tag-hebrew");
        if(this.filters.showIslamic && works.islamic.note) addCalItem("Islamic", works.islamic.date, works.islamic.note, "tag-islamic");
        if(this.filters.showRoman) addCalItem("Roman", works.roman.type, "Julian Reconstruction", "tag-roman");
        if(this.filters.showAnglo) addCalItem("Anglo-Saxon", works.anglo.month, "Bede's Reckoning", "tag-anglo");
        if(this.filters.showVedic) addCalItem("Vedic", works.vedic.tithi, `${works.vedic.paksha}, ${works.vedic.nakshatra}`, "tag-vedic");
        if(this.filters.showMeso) addCalItem("Mesoamerican", works.meso.long, works.meso.note, "tag-meso");
        if(this.filters.showAfrican) addCalItem("African", works.african.cycle, works.african.desc, "tag-african");
        
        // Shamanic/Entheogen Display
        const entDiv = document.getElementById('detail-entheo'); entDiv.innerHTML = '';
        if (this.filters.showAndean && works.andean.fixed) addCalItem("Andean", works.andean.fixed.name, works.andean.fixed.ceremony, "tag-andean");
        if (this.filters.showAmazon && works.entheo.aya.note) addCalItem("Amazonian", "Ayahuasca Cycle", works.entheo.aya.note, "tag-amazon");
        if (this.filters.showMushroom && works.entheo.mush.note) addCalItem("Mushroom", "Ceremonial Window", works.entheo.mush.note, "tag-mushroom");
        if (this.filters.showRedPath && (works.redpath.type.includes("Sweatlodge") || works.redpath.type.includes("Lodge"))) addCalItem("Red Path", works.redpath.name, works.redpath.type, "tag-redpath");
        if (this.filters.showFire && works.fire.length > 0) works.fire.forEach(f => addCalItem("Fire Ceremony", f.name, `${f.trad}. ${f.note}`, "tag-redpath"));

        // Suitability Lists
        const lg = document.getElementById('list-good'); lg.innerHTML = '';
        works.good.forEach(i => lg.innerHTML += `<div class="suit-item suit-good"><strong>${i.txt}</strong><br><span style="font-size:0.75rem;opacity:0.8">${i.src}</span></div>`);
        const lb = document.getElementById('list-bad'); lb.innerHTML = '';
        works.bad.forEach(i => lb.innerHTML += `<div class="suit-item suit-bad"><strong>${i.txt}</strong><br><span style="font-size:0.75rem;opacity:0.8">${i.src}</span></div>`);
        
        // Ceremony Focus (Merged)
        const cf = document.getElementById('detail-ceremony-focus');
        if (works.ceremony.length > 0) cf.innerHTML = works.ceremony.join("<br>");
        else cf.textContent = "General personal practice.";

        // Celtic
        document.getElementById('detail-celtic').innerHTML = `<strong>${celtic.festival ? celtic.festival + " (High Holy Day)" : celtic.name}</strong><br><span style="color:var(--text-muted); font-size:0.9rem;">${celtic.season} Season</span>`;
        document.getElementById('detail-celtic-herbal').innerHTML = celticHerbal.plant ? `<strong>${celticHerbal.plant}</strong><br>Action: ${celticHerbal.action}<br><span style="color:var(--text-muted); font-size:0.8rem;">Source: ${celticHerbal.source}</span>` : `General Seasonal Gathering`;
        
        // Deities
        const dDiv = document.getElementById('detail-deity-section'); const dList = document.getElementById('detail-deity-list'); dList.innerHTML = '';
        // Add Festivals to this list as well
        if (works.festivals.length > 0) {
             works.festivals.forEach(f => {
                const item = document.createElement('div'); item.className = 'work-item';
                let tagClass = 'tag-mixed';
                if(f.tag === 'celtic') tagClass = "tag-pagan";
                if(f.tag === 'slavic') tagClass = "tag-slavic";
                if(f.tag === 'balkan') tagClass = "tag-balkan";
                item.innerHTML = `<span class="work-tag ${tagClass}">${f.trad.split(' / ')[0]}</span><div style="font-size:0.9rem"><strong>${f.name}</strong><br><span style="color:var(--text-muted);font-size:0.8rem">Source: ${f.src}</span></div>`;
                dList.appendChild(item);
             });
        }

        if (deities.length > 0 || works.festivals.length > 0) { dDiv.style.display = 'block'; deities.forEach(d => { const item = document.createElement('div'); item.className = 'work-item'; let tagClass = 'tag-mixed'; if (d.type === 'Egyptian') tagClass = 'tag-egypt'; if (d.type === 'Christian') tagClass = 'tag-marian'; if (d.type === 'Buddhist') tagClass = 'tag-buddhist'; item.innerHTML = `<span class="work-tag ${tagClass}">${d.type}</span><div style="font-size:0.9rem"><strong>${d.name}</strong><br><span style="color:var(--text-muted);font-size:0.8rem">Associated with ${d.deity}. Source: ${d.source}. ${d.note || ''}</span></div>`; dList.appendChild(item); }); } else { dDiv.style.display = 'none'; }
        
        // Scottish Herbs Display
        const shList = document.getElementById('detail-scottish-herbs'); shList.innerHTML = '';
        const suitableHerbs = works.scottishHerbs.filter(h => h.suitable);
        if (suitableHerbs.length > 0) {
             suitableHerbs.forEach(h => {
                const item = document.createElement('div'); item.className = 'work-item';
                item.innerHTML = `<span class="work-tag tag-scottish">Harvest</span><div style="font-size:0.9rem"><strong>${h.name}</strong> (${h.part})<br><span style="color:var(--text-muted);font-size:0.8rem">${h.note}</span></div>`;
                shList.appendChild(item);
             });
        } else {
             shList.innerHTML = `<div style="font-style:italic; color:var(--text-muted);">No specific herbs listed for harvest today based on phase.</div>`;
        }

        // Work List (Aggregated from old logic + new suitability)
        const wl = document.getElementById('work-list'); wl.innerHTML = '';
        // Tinctures
        let tincStatus = "Mixed"; if(moon.phaseIdx===0) tincStatus="Avoid"; if(moon.phaseIdx===4) tincStatus="Suitable";
        wl.innerHTML += `<div class="work-item"><span class="work-tag tag-${tincStatus.toLowerCase()}">${tincStatus}</span><div style="font-size:0.9rem"><strong>Tinctures</strong><br><span style="color:var(--text-muted);font-size:0.8rem">Western Herbalism logic based on fluid dynamics.</span></div></div>`;

        document.getElementById('detail-uk-herbs').innerHTML = ukHerbs.available.length > 0 ? ukHerbs.available.map(h => `<div><strong>${h.name}</strong> (${h.part})</div>`).join('') : "No specific key herbs listed.";
        document.getElementById('detail-elem-icon').innerHTML = SVGS.element(bio.element, 'icon-lg');
        document.getElementById('detail-elem-name').textContent = `${bio.type} (${bio.element.toUpperCase()})`;
        document.getElementById('detail-tarot').textContent = TAROT_GD[moon.signIdx];
        document.getElementById('detail-tcm').innerHTML = `<span style="color:var(--color-tcm); font-weight:bold;">${tcm.type}</span><br>${tcm.guidance}<br><span style="font-size:0.8rem; color:var(--text-muted);">Source: ${tcm.source}</span>`;
        document.getElementById('detail-shamanic').innerHTML = `<strong>${shaman.ceremony || "General Practice"}</strong><br>${shaman.desc}<br><span style="font-size:0.8rem; color:var(--text-muted);">Source: ${shaman.source}</span>`;
        document.getElementById('detail-quero').innerHTML = `<span style="color:var(--color-quero); font-weight:bold;">${quero.name}</span><br>${quero.type}<br><span style="font-size:0.8rem; color:var(--text-muted);">Source: ${quero.source}</span>`;
        document.getElementById('detail-redpath').innerHTML = `<span style="color:var(--color-redpath); font-weight:bold;">${redpath.name}</span><br>${redpath.type}<br><span style="font-size:0.8rem; color:var(--text-muted);">Source: ${redpath.source}</span>`;
        
        document.getElementById('day-note').value = notes[key] || '';
        document.getElementById('detail-panel').classList.add('open');
    },

    setupListeners() {
        document.getElementById('btn-prev').onclick = () => { this.date.setMonth(this.date.getMonth()-1); this.render(); };
        document.getElementById('btn-next').onclick = () => { this.date.setMonth(this.date.getMonth()+1); this.render(); };
        document.getElementById('date-picker').onchange = (e) => { const p = e.target.value.split('-'); this.date = new Date(p[0], p[1]-1, p[2]); this.render(); };
        document.getElementById('theme-selector').onchange = (e) => this.applyTheme(e.target.value);
        document.getElementById('btn-close').onclick = () => document.getElementById('detail-panel').classList.remove('open');
        document.getElementById('day-note').oninput = (e) => { const k = this.selectedDate.toISOString().split('T')[0]; const n = JSON.parse(Storage.get('arc_notes') || '{}'); n[k] = e.target.value; Storage.set('arc_notes', JSON.stringify(n)); this.render(); };
        document.getElementById('btn-logo').onclick = () => { const currentPos = Storage.get('arc_logo_pos') || 'logo-top-center'; const newPos = currentPos === 'logo-top-center' ? 'logo-bottom-right' : 'logo-top-center'; Storage.set('arc_logo_pos', newPos); document.getElementById('user-logo').className = newPos; };
        const bibList = document.getElementById('bib-list'); BIBLIOGRAPHY.forEach(b => { const div = document.createElement('div'); div.className = 'bib-item'; div.innerHTML = `<div class="bib-title">${b.title}</div><div class="bib-meta">${b.meta}</div>`; bibList.appendChild(div); });
        document.getElementById('btn-bib').onclick = () => document.getElementById('bib-panel').classList.add('open');
        document.getElementById('btn-close-bib').onclick = () => document.getElementById('bib-panel').classList.remove('open');
        document.getElementById('btn-filters').onclick = () => document.getElementById('settings-panel').classList.add('open');
        document.getElementById('btn-close-settings').onclick = () => document.getElementById('settings-panel').classList.remove('open');
        document.getElementById('btn-summary').onclick = () => { this.renderSummary(); document.getElementById('summary-panel').classList.add('open'); };
        document.getElementById('btn-close-summary').onclick = () => document.getElementById('summary-panel').classList.remove('open');
    }
};

App.init();

</script>
<script type="module" src="/index.tsx"></script>
</body>
</html>